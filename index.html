
<!doctype html>
<html lang="en">
  <head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.youtube.com/iframe_api"></script>
    
<!-- ==============================
     Firebase Setup (Compat version)
     ============================== -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDKY72fjO-tiu3otsBzh3F3xw5JyXJB_uk",
    authDomain: "cuetube-cb101.firebaseapp.com",
    projectId: "cuetube-cb101",
    storageBucket: "cuetube-cb101.firebasestorage.app",
    messagingSenderId: "364944752363",
    appId: "1:364944752363:web:11279eeff48844073f88ae",
    measurementId: "G-XXBQKLJRZT"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const analytics = firebase.analytics();
  const auth = firebase.auth();
  const db = firebase.firestore();

  console.log("‚úÖ Firebase initialized (compat)");
</script>
    
<script>
let currentUser = null;

// ---------- Toggle Register/Login Card ----------
function toggleAuth() {
  const log = document.getElementById("loginCard");
  const reg = document.getElementById("registerCard");
  if (reg.style.display === "none") {
    reg.style.display = "block";
    log.style.display = "none";
  } else {
    reg.style.display = "none";
    log.style.display = "block";
  }
}

// ---------- Show Main UI ----------
function onLoginSuccess() {
  document.getElementById("authOverlay").style.display = "none";
  document.getElementById("mainCueTubeUI").style.display = "block";

  // ‚úÖ Start listening for incoming songs after login
  if (currentUser && currentUser.id) {
    listenForIncomingSongs(currentUser.id);
  }

  // Load songbook after UI is visible
  loadSongbook();
}


// ==============================
// Listen for Incoming Transfers
// ==============================
function listenForIncomingSongs(userId) {
  db.collection("transfers")
    .where("to", "==", userId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const data = change.doc.data();
          const song = data.song;

          // Add to queue
          if (queue.length === 0 && currentIndex === -1) {
            queue.push(song);
            currentIndex = 0;
            player.loadVideoById(song.id);
            player.playVideo();
            updateNowPlaying();
          } else {
            queue.push(song);
            updateQueueDisplay();
          }

          // Notify
          playNotifSound();
          showAlert("‚úÖ New Song added to Queue", "success");

          // Delete transfer after processing
          db.collection("transfers").doc(change.doc.id).delete();
        }
      });
    });
}


// ==============================
// Load Songbook from Firestore
// ==============================
async function loadSongbook() {
  if (!currentUser || !currentUser.id) return;

  const userRef = db.collection("users").doc(currentUser.id);
  const doc = await userRef.get();
  if (!doc.exists) return;

  const data = doc.data();
  const songList = document.getElementById("songbookList");
  songList.innerHTML = "";

  if (Array.isArray(data.songbook)) {
    data.songbook.forEach(song => {
      const songDiv = document.createElement("div");
      songDiv.className = "songtitle";
      songDiv.textContent = song.title;
      const videoId = extractVideoId(song.url);
      songDiv.dataset.url = song.url;
      songDiv.dataset.id = videoId;
      attachSongbookInteractions(songDiv);
      songList.appendChild(songDiv);
    });
  }
}

// ---------- Register User ----------
async function registerUser() {
  playClickSound();
  const userID = document.getElementById("regUser").value.trim();
  const password = document.getElementById("regPass").value.trim();
  const nickname = document.getElementById("regNick").value.trim();

  if (!userID || !password || !nickname) {
    playErrorSound();
    showAlert("‚ö†Ô∏è Fill all fields", "info");
    return;
  }

  // ‚úÖ Length validations
  if (userID.length < 3 || userID.length > 5) {
    playErrorSound();
    showAlert("‚ö†Ô∏è User ID must be 3‚Äì5 characters", "info");
    return;
  }
  if (password.length < 5) {
    playErrorSound();
    showAlert("‚ö†Ô∏è Password must be at least 5 characters", "info");
    return;
  }
  if (nickname.length < 3 || nickname.length > 10) {
    playErrorSound();
    showAlert("‚ö†Ô∏è Nickname must be 3‚Äì10 characters", "info");
    return;
  }

  const userRef = db.collection("users").doc(userID);
  const doc = await userRef.get();
  if (doc.exists) {
    playErrorSound();
    showAlert("‚ö†Ô∏è User ID already taken", "info");
    return;
  }

  // Save new user
  await userRef.set({ password, nickname, songbook: [], queue: [] });

  // AUTO-LOGIN using the nickname we just saved
  currentUser = { id: userID, nickname: nickname };

  playSuccessSound();
  showAlert(`üéâ Account created! Welcome ${currentUser.nickname}`, "success");
  onLoginSuccess();
}

// ---------- Login User ----------
async function loginUser() {
  playClickSound();
  const userID = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();

  const userRef = db.collection("users").doc(userID);
  const doc = await userRef.get();
  if (!doc.exists || doc.data().password !== password) {
    playErrorSound();
    showAlert("‚ùå Invalid UserID or Password", "error");
    return;
  }

  currentUser = { id: userID, nickname: doc.data().nickname };

  // üîπ Different message for login
  playSuccessSound();
  showAlert(`‚úÖ Logged in as ${currentUser.nickname}`, "success");
  onLoginSuccess(); // Will also load songbook
}


// ---------- Alert (Toast System) ----------
function showAlert(message, type = "info") {
  const container = document.getElementById("alertContainer");

  // Create a new alert
  const alertBox = document.createElement("div");
  alertBox.className = `custom-alert ${type}`;
  alertBox.textContent = message;

  container.appendChild(alertBox);

  // Animate in
  setTimeout(() => {
    alertBox.classList.add("show");
  }, 10);

  // Auto remove after 2.5s
  setTimeout(() => {
    alertBox.classList.remove("show");
    setTimeout(() => alertBox.remove(), 300); // wait for transition
  }, 2500);
}
</script>

    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="CueTube Icon.png" />
    <title>BRD Christmas Party!</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
    
<style>

      button {
        padding: 10px 20px;
        margin-left: 10px;
        font-size: 1em;
        cursor: pointer;
      }
      #queue {
        margin-top: 30px;
        border-top: 1px solid #444;
        padding-top: 10px;
      }
      .queue-item {
        padding: 8px;
        background: #222;
        border: 1px solid #333;
        margin-bottom: 5px;
      }
  
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(#003535, black);
        font-family: "Segoe UI", sans-serif;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }
  
  
/*  =============================
    CUETUBE TITLE +++++++
    ===================== */
    .title-bar {
      font-family: "Orbitron", sans-serif;
      font-size: 1.2em;
      text-align: center;
      padding: 20px 0px;
      color: cyan;
      background-color: rgba(0, 0, 0, 0.5);
      filter: blur(6);
      position: relative;
      animation: neon-text 3s ease-in-out infinite alternate;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      user-select: none; /* prevent text selection */
    }
  
    .title-icon {
      height: 50px;
      width: 50px;
      cursor: pointer; /* clickable */
      user-select: none; /* prevent text selection */
      animation: neon-glow 3s ease-in-out infinite alternate;
    }
    .title-icon:active {
      transform: scale(0.9); /* shrink slightly */
      opacity: 0.7; /* fade */
    }
  
    /* Neon text animation */
    @keyframes neon-text {
      from {
        text-shadow:
          0 0 2px cyan,
          0 0 4px cyan;
      }
      to {
        text-shadow:
          0 0 8px cyan,
          0 0 16px cyan;
      }
    }
  
    /* Neon image glow using drop-shadow */
    @keyframes neon-glow {
      from {
        filter: drop-shadow(0 0 1px cyan) drop-shadow(0 0 2px cyan);
      }
      to {
        filter: drop-shadow(0 0 4px cyan) drop-shadow(0 0 8px cyan);
      }
    }
  
    /* Neon glow for popups */
    @keyframes pulseGlow {
      from {
        filter: drop-shadow(0 0 1px var(--glow-color)) drop-shadow(0 0 2px var(--glow-color));
      }
      to {
        filter: drop-shadow(0 0 4px var(--glow-color)) drop-shadow(0 0 8px var(--glow-color));
      }
    }
  
    .glow-text {
      animation: pulseGlow 1.5s infinite alternate;
    }
  
    .static-glow {
      filter: drop-shadow(0 0 4px var(--glow-color)) drop-shadow(0 0 8px var(--glow-color));
    }
  
/*  =============================
    YOUTUBE SCREEN ++++++++++++++
    =============================  */
    .youtube-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 50vh; /* 50% of the screen height */
      padding: 0;
      margin: 0;
    }
  
    .youtube-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
      outline: none !important;
      display: block;
    }
  
/*  ============================
    NOTIFICATION +++++++++++++++
    ============================ */
    .notify-box {
      display: flex;
      height: 60px;
      width: 90%; /* leaves 5% space on each side */
      margin: 5px 5%; /* top/bottom = 10px, left/right = 5% */
      padding: 5px;
      box-sizing: border-box;
    }
  
    .Notify {
      display: flex;
      align-items: center; /* vertical alignment (centered on y-axis) */
      justify-content: center; /* items aligned to the left (x-axis) */
      overflow: hidden;
      position: relative;
      border-radius: 1.5px;
      width: 80%;
      height: 100%;
      background-color: none;
    }
  
    /* Line */
    .Notify .line {
      width: 3px;
      height: 100%;
      background-color: chartreuse;
      /*rgba(91, 24, 194, 1);= #7f95e4;*/
      opacity: 0;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      animation: fadeIn 3s forwards;
    }
  
    /* Text */
    .Notify .text {
      color: white;
      /*text-shadow:
        0 0 8px black,
        0 0 8px black,
        0 0 12px #222,
        0 0 24px #222;*/
      font-family: "Segoe UI", sans-serif;
      font-size: 1em;
      word-wrap: break-word;
      opacity: 0;
      transform: translateX(-100%);
      animation: slideOut 0.8s forwards;
      animation-delay: 0.5s;
      margin-left: 25px;
      position: relative;
      white-space: normal; /* allow wrapping */
      word-wrap: break-word; /* break long words if needed */
      padding: 5px 0; /* keep alignment with vertical line */
      box-sizing: border-box;
      width: 100vw; /* 100% of viewport width */
      left: 0; /* stick to left edge */
      position: relative;
      background-color: none;
    }
  
    /* Show animations */
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }
  
    @keyframes slideOut {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  
    /* Hide animations */
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }
  
    @keyframes slideIn {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-100%);
      }
    }
  
    .Notify.hide .line {
      animation: fadeOut 1.5s forwards;
    }
  
    .Notify.hide .text {
      animation: slideIn 1.2s forwards;
    }
  
/*  ============================
    LEFT DRAWER ++++++++++++++++++
    ============================== */
    /* Left Drawer body */
    .drawer {
      flex: 1;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: -90%; /* hidden off-screen */
      width: 90%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(13, 14, 14, 0.6) 0%, #000000 100%);
      padding: 0px;
      z-index: 99;
      transition: left 0.3s cubic-bezier(0.25, 1.15, 0.5, 1);
    }
  
    .drawer::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(13, 14, 14, 0) 0%, rgba(13, 14, 14, 0.6) 60%, #000000 100%);
      z-index: 10;
      pointer-events: none;
    }
  
    .drawer.open {
      left: 0%; /* stop 20% before the right edge ‚Üí looks like 80% */
      animation: shadowFloat 5s infinite ease-in-out;
    }

  
    @keyframes shadowFloat {
      0% {
        box-shadow: 0 -10px 30px rgba(0, 255, 255, 0.01);
      }
      50% {
        box-shadow: 0 10px 80px rgba(0, 255, 255, 0.1);
      }
      100% {
        box-shadow: 0 -10px 30px rgba(0, 255, 255, 0.01);
      }
    }
  
/*  ============================
    Left Drawer Handle
    =========================== */
    .drawer-handle {
      position: absolute;
      top: 7px;
      right: -55px;
      width: 50px;
      height: 50px;
      background: none;
      color: #cdcdcd;
      font-size: 1.8em; /* bigger text */
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 80;
      user-select: none; /* prevent text selection */
      text-shadow: none; /* no glow by default */
      -webkit-tap-highlight-color: transparent; /* no blue/red flash */
      -webkit-text-stroke: 0px transparent;
      transition:
        opacity 1s ease-in-out,
        color 0.2s ease,
        -webkit-text-stroke 0.1s ease,
        transform 0.1s ease-in-out;
    }
      
    .drawer-handle.idle {
      opacity: 0.2; /* fade to 20% when idle */
    }
      
    /* Hover + Focus-visible share same effect */
    .drawer-handle:hover,
    .drawer-handle:focus-visible {
      outline: none; /* remove dotted outline for keyboard */
      opacity: 1 !important; /* ensure visible while interacting */
      color: cyan;
      -webkit-text-stroke: 0px cyan;
      text-shadow:
        0 0 8px cyan,
        0 0 8px cyan,
        0 0 12px cyan,
        0 0 24px cyan;
      /*transform: scale(1.05);  enlarge a bit */
    }
      
    /* Overlay for Left and Bottom drawer ??? */
    .drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 90;
      display: none;
    }
    .drawer-overlay.visible {
      display: block;
    }
      
    .drawer > div {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .drawer.open {
      display: flex;
    }
  
/*  ==================
    Nowplaying-box
    ================= */

    /* Box */
    .nowplaying-box {
      display: flex;
      flex-direction: column;
      border-radius: 20px;
      padding: 18px;
      background: black;
      border: 1px solid var(--btn-glow, #000000);
      transition: box-shadow 0.5s;
    }
  
    /* Hover or Active (when a song is playing) */
    .nowplaying-box:hover,
    .nowplaying-box.active {
      z-index: 99;
      border: 1px solid var(--btn-glow, cyan);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, cyan),
        inset 0 0 10px 0.5px var(--btn-glow, cyan);
    }
  
    /* Label (Nowplaying) */
    .nowplaying-box .label {
      font-family: "Orbitron", sans-serif;
      font-size: 1em;
      color: #222;
      margin-bottom: 15px;
    }
  
    /* Label highlights when the BOX is hovered OR active */
    .nowplaying-box:hover .label,
    .nowplaying-box.active .label {
      color: cyan;
    }
  
    /* Song titles inside Nowplaying-box */
    .nowplaying-box .title {
      font-family: "Segoe UI", sans-serif;
      font-size: 1em;
      margin: 5px 0;
      word-wrap: break-word;
      font-weight: regular;
    }
  
    /* Glowing effect for Now Playing title */
    .now-playing-glow {
      color: white;
      text-shadow:
        0 0 5px magenta,
        0 0 10px magenta,
        0 0 20px magenta,
        0 0 30px magenta;
      animation: glowPulse 2s infinite alternate;
    }
  
    @keyframes glowPulse {
      from {
        text-shadow:
          0 0 2px magenta,
          0 0 2px magenta,
          0 0 2px magenta;
      }
      to {
        text-shadow:
          0 0 12px magenta,
          0 0 20px magenta,
          0 0 20px magenta;
      }
    }

/*  ==========================
    Main Group
    ========================== */  
    .main-group {
      padding: 15px 15px 15px 20px; /* top/Right/bott/Left*/
    }
  
/*  ==========================
    Group A
    ========================== */
    .group-a {
      background-color: none;
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }
  
/*  ==========================
    Group B
    ========================== */
    .group-b {
      background-color: none;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }
  
/*  ==========================
    Next-box (Modern Hidden Scrollbar)
    ========================== */
    .next-box {
      position: relative;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding: 10px;
      margin-top: 10px;

      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;

      /* Firefox support */
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;

      /* Create smooth fade animation container */
      transition: scrollbar-color 0.5s ease;
    }

    /* Inner wrapper for stretch */
    .next-box-inner {
      will-change: transform;
      transition: transform 0.3s ease;
    }

    /* ===== Scrollbar Styling (WebKit Browsers) ===== */
    .next-box::-webkit-scrollbar {
      width: 8px;
    }

    /* Track ‚Äî invisible */
    .next-box::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 10px;
    }

    /* Thumb ‚Äî starts hidden */
    .next-box::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.6s ease, background 0.3s ease;
    }

    /* Fade in on hover */
    .next-box:hover::-webkit-scrollbar-thumb {
      opacity: 1;
      background: rgba(255, 255, 255, 0.25);
    }

    /* Slightly brighter on hover-over thumb */
    .next-box:hover::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Firefox equivalent */
    .next-box:hover {
      scrollbar-color: rgba(255, 255, 255, 0.25) transparent;
    }

    /* Smooth fade-out animation using pseudo element */
    .next-box:not(:hover)::-webkit-scrollbar-thumb {
      transition: opacity 0.8s ease, background 0.3s ease;
      opacity: 0;
    }

  
    .next-box.hidden {
      display: none !important;
    }
  
    #overflowCounter {
      text-align: center;
      font-size: 1em;
      color: #888;
      margin-top: 5px;
      display: none;
    }
  
    /* Label (NEXT) */
    .next-box .label {
      font-family: "Orbitron", sans-serif;
      font-size: 0.8em;
      color: grey;
    }
  
    /* Song Titles inside Next-box */
    .next-box .songtitle {
      color: white;
      font-family: "Segoe UI", sans-serif;
      font-size: 1em;
      margin: 10px 0;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: normal;
      padding: 5px;
      
      position: relative;
      overflow: hidden;
      user-select: none;
      cursor: pointer;
    }
  
/*  ================================
    Song Deletion Animation
    =============================== */
    .next-box .songtitle.removing {
      opacity: 0;
      transform: translateX(50px); /* slide out to the right */
      transition:
        opacity 0.6s ease,
        transform 0.6s ease;
    }
  
/*  ================================
    Ripple Overlay (Base)
    =============================== */
    .next-box .songtitle::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(128, 128, 128, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
  
      /* Click Ripple */
      .next-box .songtitle.ripple::after {
        opacity: 1;
        transition: opacity 0s;
      }
  
      /* Hover Flash */
      .next-box .songtitle.hover-flash::after {
        opacity: 1;
        transition: opacity 0.5s ease;
      }
  
      /* Long Press / Right-click Red Highlight */
      .next-box .songtitle.long-pressing {
        background-color: rgba(255, 0, 0, 0.25) !important;
        color: #ff4c4c !important;
        transition: background-color 0.3s ease !important;
      }
  
/*  =============================
    BOTTOM DRAWER +++++++++++++++
    =============================  */
    /* Bottom Drawer body */
    .bottom-drawer {
      position: fixed;
      bottom: -160px;
      left: 0;
      width: 100%;
      background: linear-gradient(to bottom, rgba(13, 14, 14, 0.6) 0%, #000000 100%);
      padding: 20px 15px 15px 25px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
      transition: bottom 0.3s cubic-bezier(0.25, 1.25, 0.5, 1);
      z-index: 98;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 15px 25px; /* bottom is 25px default */
    }
  
    /* bottom-drawer When open --start */
    .bottom-drawer.open {
      bottom: 0;
      animation: shadowFloat 5s infinite ease-in-out;
    }
  
    /* Shadow moves up and down */
    @keyframes shadowFloat {
      0% {
        box-shadow: -10px 0 30px rgba(0, 255, 255, 0.01);
      }
      50% {
        box-shadow: 10px 0 80px rgba(0, 255, 255, 0.1);
      }
      100% {
        box-shadow: -10px 0 30px rgba(0, 255, 255, 0.01);
      }
    }
  
/*  ==============================
    Bottom drawer Handle
    =============================  */
    .bottom-drawer-handle {
      position: absolute;
      top: -80px;
      left: 49%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #cdcdcd; /* default color */
      font-size: 2em;
      cursor: pointer;
      text-shadow: none; /* üö´ no glow */
      -webkit-text-stroke: 0px transparent;
      z-index: 99;
      user-select: none;
      transition:
        opacity 1s ease-in-out,
        color 0.2s ease,
        -webkit-text-stroke 0.1s ease,
        transform 0.1s ease-in-out;
      opacity: 1; /* start fully visible */
      padding: 10px; /* bigger tap zone */
      -webkit-tap-highlight-color: transparent; /* no blue/red flash */
    }
  
    .bottom-drawer-handle.idle {
      opacity: 0.2; /* fade to 20% when idle */
    }
  
    /* Hover/focus overrides idle */
    .bottom-drawer-handle:hover,
    .bottom-drawer-handle:focus-visible {
      outline: none;
      opacity: 1 !important;
      color: cyan;
      -webkit-text-stroke: 0px cyan;
      text-shadow:
        0 0 8px cyan,
        0 0 8px cyan,
        0 0 12px cyan,
        0 0 24px cyan;
    }
  
/*  ===============================
    Url box + Paste button Group
    ============================== */
    .url-group {
      width: 60vw;
      display: flex;
      justify-content: center; /* space between grandchildren */
      align-items: center;
      position: relative;
      min-width: 300px;
      gap: 8px;
      margin-bottom: 20px;
    }
  
/*  ==============================
    Url box
    =============================  */
    .url-input {
      flex: 1;
      width: 100%;
      min-width: 210px;
      max-width: 50vw;
      height: 40px;
      border-radius: 10px;
      border: none;
      background-color: #1a1a1a;
      text-align: center;
      
      cursor: pointer;
      transition:
        transform 1s,
        box-shadow 0.3s;
    }
  
    /* Hover effect */
    .url-input:hover {
      box-shadow: 0 0 10px 0.5px var(--btn-glow, #222); /* outer glow */
    }
  
    .url-input.glow {
      border: 1px solid var(--btn-glow, white);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, magenta),
        /* outer glow */ inset 0 0 10px 0.5px var(--btn-glow, magenta); /* inner glow */
    }
  

    /* General Input text/password box*/

    input[type="text"]::placeholder,
    input[type="password"]:::placeholder   {
      color: #222;
      opacity: 0.3;
    }
  
    input[type="text"],
    input[type="password"] {
      width: 60%;
      border: 2px magenta;
      border-radius: 8px;
      padding: 10px;
      font-size: 1em;
      background-color: black; /*#121212;*/
      color: white;
      box-shadow: 0 0 15px 1px var(--btn-glow, rgba(33, 32, 32, 0.32));
      transition: box-shadow 0.3s ease;
    }
  
    input[type="text"]:focus,
    input[type="password"]:focus  {
      outline: 1px;
      border-color: solid white;
      border: 1px solid var(--btn-glow, white);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, magenta),/* outer glow */
        inset 0 0 5px 0.5px var(--btn-glow, magenta); /* inner glow */
      background-color: black !important; /* stay black when focused */
      color: white !important;
    }
  
    /* for Suggested URL - Normal focus */
    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border: 1px solid var(--btn-glow, white);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, magenta),/* outer glow */
        inset 0 0 5px 0.5px var(--btn-glow, magenta); /* inner glow */
    }
  
    /* Autofill fix */
    input[type="text"]:-webkit-autofill,
    input[type="password"]:-webkit-autofill {
      border: 1px solid white;
      -webkit-box-shadow:
        0 0 10px 0.5px var(--btn-glow, magenta),
        inset 0 0 10px 0.5px var(--btn-glow, magenta),
        0 0 0px 1000px black inset !important;
      -webkit-text-fill-color: white !important;
      caret-color: white;
    }
  
/*  =============================
    Paste button
    =============================  */
    .paste-btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 11px;
      margin-left: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      filter: drop-shadow(0 0 2px black) drop-shadow(0 0 6.5px black);
      cursor: pointer;
      transition:
        transform 1s,
        filter 0.3s;
    }
  
    .paste-btn-icon:active {
      transform: scale(0.95);
      transform: translateY(2px);
    }

    .paste-icon-image {
      width: 22px;
      height: 22px;
      content: url("Paste Icon.png"); /* default icon */
    }
  
    /* Optional glow & Change imagewhen pressed */
    .paste-btn-icon:active img {
      content: url("Paste Icon 2.png"); /* works here */
      filter: drop-shadow(0 0 2px magenta) drop-shadow(0 0 6.5px magenta) drop-shadow(0 0 15px magenta);
    }
  
    .paste-btn-icon:hover {
      filter: drop-shadow(0 0 3px black) drop-shadow(0 0 5px black) drop-shadow(0 0 1.5px #222)
        drop-shadow(0 0 8px #222);
    }
  
/*  =============================
    Bottom buttons
    =============================  */
    .bottom-buttons {
      justify-content: center; /* center buttons */
      gap: 15px; /* spacing between buttons */
      width: 100%;
      display: flex;
      justify-content: space-between; /* default: spread buttons apart */
      align-items: center;
      z-index: 5;
    }
  
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom, rgba(13, 14, 14, 0) 0%, rgba(13, 14, 14, 0.5) 60%, #000000 100%);
      z-index: 999;
    }
  
    /* Invisible overlay for Tap/close */
    .bot-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: invisible;
      z-index: 90;
      display: none;
    }
    .bot-drawer-overlay.visible {
      display: block;
    }
  
/*  =============================================
    Typical Buttons (Bottom buttons and Confirm's)
    ===============================================  */
    /* Note: Button Style (color is dynamic via CSS vars) */
    .cyan-btn {
      margin: 0;
      flex: 1;
      padding: 14px;
      background: black;
      border-radius: 10px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition:
        background 0.3s,
        color 0.3s,
        transform 0.15s,
        box-shadow 0.3s;
      border: 1px solid var(--btn-glow, cyan);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, cyan),
        /* outer glow */ inset 0 0 10px 0.5px var(--btn-glow, cyan); /* inner glow */
    }
  
      /* Hover effect */
      .cyan-btn:hover {
        background: var(--btn-hover-bg, rgba(0, 255, 255, 0.2)); /* set by JS */
        color: white;
        text-shadow: 0 0 16px var(--btn-glow, #222);
      }
  
      /* Press / click effect */
      .cyan-btn:active {
        transform: scale(0.9); /* shrink when pressed */
        box-shadow:
          0 0 5px var(--btn-glow, cyan),
          0 0 20px var(--btn-glow, cyan) inset; /* temporary glow */
        background: var(--btn-glow, cyan);
        color: black;
        transition:
          transform 0.15s,
          box-shadow 0.15s; /* faster transition */
      }
  
      /* Reset hover/glow after click (if you toggle this class in your code) */
      .cyan-btn.clicked {
        transform: scale(1);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
  
/*  =========================
    Exit Modal
    ========================  */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      border: 2px solid red;
      border-radius: 10px;
      padding: 20px;
      z-index: 1000;
      text-align: center;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 0 20px red;
    }
  
    .single-btn {
      width: 45%;
      max-width: 200px;
    }
  
/*  =============================
    Touchpad +++++++++++++++++++
    ============================  */
    .touchpad {
      display: none;
      position: fixed;
      top: 45px;
      right: 45px;
      width: 40vw;
      height: 62vh;
      background: invisible;
      outline: none;
      z-index: 999;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent; /* no blue/red flash */
    }
  
  
/*  ============================
    On wider screens (like PC), use 70% width
    ============================ */  
    @media (min-width: 768px) {
      .bottom-buttons {
        width: 70vw !important;
      }
      .drawer {
        left: -40%; /* hidden off-screen */
        width: 40%;
      }
      .group-a {
        margin-top: 15px;
      } 
    }
/*  ============================
    Landscape Mode
    ============================ */
     @media screen and (orientation: landscape) and (max-width: 915px) {
      .touchpad {
        display: block !important;
      }
      
      .title-bar {
        display: none !important;
      }
      
      .notify-box {
        position: fixed;
        top: 13vh;
        left: 45vw;
        width: 50vw;
        transform: translateX(-50%);
        z-index: 1;
      }
      
      .Notify {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        width: 50vw;
        height: 100%;
        /*background: linear-gradient(
        to left,
        rgba(0, 0, 0, 0) 0,
        rgba(0, 0, 0, 0.050) 0 0%
        );*/
        backdrop-filter: blur(5px);
      }
      
      .youtube-wrapper {
        position: fixed !important;
        left: 50vw !important;
        transform: translateX(-50%) !important;
        width: 100vw !important;
        height: 100vh !important;
      }
      
      #popupModal {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
      }
      
      /* Drawer landscape*/
      .drawer {
        width: 90% !important;
        left: -90% !important;
        height: 100vh; /* Full screen height in landscape */
      }
      .drawer.open {
        left: 0px !important;
      }
        
      .nowplaying-box {
        margin-top: 4% !important;
        left: 0px !important;
      }

      .group-a,
      .group-b {
        padding: 8px;
      }
      .songbook,
      .nowplaying-box,
      .next-box {
        scale: .90;
        margin: 0px;
        width: 105%;
      }
      
      /* Bottom Drawer landscape*/
      .bottom-drawer {
        bottom: -100px;
        width: 100vw !important;
        height: 100px !important;
      }
      
      .bottom-drawer-handle,
      .drawer-handle {
        z-index: 9999 !important;
        color: white !important;
        -webkit-text-stroke: 0px magenta;
        text-shadow:
          0 0 8px magenta,
          0 0 8px magenta,
          0 0 12px magenta,
          0 0 24px magenta;
      }
      
      .bottom-drawer-handle.idle,
      .drawer-handle.idle {
        opacity: 0.01 !important;
      }
      
      .url-group {
        min-width: 30vw!important;
        width: 40vw !important;
        position: absolute !important;
        top: 50% !important;
        right: 3% !important;
        transform: translate(0, -50%) !important;
        gap: 10px !important;
        font-size: .9em !important;
      }
      
      .paste-btn-icon {
        margin-left: 5px !important;
      }

      .bottom-buttons {
        width: 50vw !important;
        position: absolute !important;
        top: 50% !important;
        left: 4% !important;
        transform: translate(0, -50%) !important;
        gap: 2% !important;
      }
      .url-input,
      .search-bar {
        display: block; /* Make sure it's visible */
      }
      
    }
  
/* ========================================
    Popups Text with glow (Reserve, etc.)
   ======================================= */
    #popupOverlay {
      position: fixed;
      top: 80%;
      left: 50%;
      width: 100%;
      height: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, #000000 80%);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease; /* normal fade */
      z-index: 9999;
    }

    #popupOverlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Slow fade for overlay */
    #popupOverlay.slow-fade {
      transition: opacity 1.0s ease;
    }

/* ========================================
   Popup Base
   (Centered text with glow)
   ======================================= */
    #popupModal {
      position: fixed;
      top: 75%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: none !important;
      border: none !important;
      border-radius: 10px;
      padding: 0 !important;
      color: inherit;
      font-family: "Orbitron", sans-serif;
      font-weight: bold;
      text-align: center !important;
      text-shadow: inherit;
      z-index: 99999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease; /* normal fade */
      max-width: 90vw;
      box-shadow: none !important;
      user-select: none;
      font-size: 1.8em !important;
    }

    /* Popup show: fade in */
    #popupModal.show {
      opacity: 1;
      visibility: visible;
    }

    /* Confirm Delete (your other popup) */
    #confirmDelete {
      transition: opacity 0.3s ease;
      opacity: 1;
    }
    #confirmDelete.show {
      opacity: 1;
    }
  
  
/*  =============================
    Generic Modal Base
    ============================= */
    .overlay {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      border-radius: 10px;
      padding: 20px 30px;
      z-index: 1000;
      text-align: center;
      min-width: 260px;
      border: 1px solid cyan; /* will be overridden by JS */
      box-shadow: 0 0 10px 0.5px cyan; /* will be overridden by JS */
    }
  
    .modal-content p {
      margin: 8px 0;
      font-size: 1em;
      color: white;
    }
  
/*  ===============================
    SongBook Queue
    =============================== */
    .songbook {
      display: flex;
      flex-direction: column;
      border-radius: 20px;
      padding: 10px;
      overflow: hidden;

      background: none;
      border: 1px solid var(--btn-glow, white);
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, magenta),
        inset 0 0 10px 0.5px var(--btn-glow, magenta);
      transition:
        transform 0.5s ease,
        max-height 0.5s ease;
      z-index: 999;
    }

    /* Handle bar (Songbook Button) */
    .songbook-handle {
      font-family: "Orbitron", sans-serif;
      font-size: 1.1em;
      text-align: center;
      padding: 10px;
      color: #9377ea;
      background: none;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s ease, color 0.2s ease, text-shadow 0.2s ease;
    }

    /* Hover effect (PC) */
    .songbook-handle:hover {
      color: #dcd1ff;
      text-shadow:
        0 0 8px #9377ea,
        0 0 12px #9377ea,
        0 0 24px #9377ea;
    }

    /* Click effect */
    .songbook-handle.clicked {
      transform: scale(0.85);
    }

    /* Songbook list container */
    .songbook-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
      padding: 0 10px;
    }

    /* Expanded state */
    .songbook.open .songbook-list {
      max-height: 65vh;
    }

    /* Scrollable box */
    .songbook-box {
      position: relative;
      overflow: hidden;
      height: 100%;
    }

    .songbook-box-inner {
      height: 100%;
      max-height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      overscroll-behavior: contain;
      touch-action: pan-y;

      /* Firefox scrollbar */
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
      transition: scrollbar-color 0.5s ease;
    }

    /* ===== Scrollbar Styling (WebKit) ===== */
    .songbook-box-inner::-webkit-scrollbar {
      width: 8px;
    }

    /* Track ‚Äî invisible */
    .songbook-box-inner::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 10px;
    }

    /* Thumb ‚Äî hidden until hover */
    .songbook-box-inner::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.6s ease, background 0.3s ease;
    }

    /* Fade in on hover */
    .songbook-box-inner:hover::-webkit-scrollbar-thumb {
      opacity: 1;
      background: rgba(255, 255, 255, 0.25);
    }

    /* Thumb hover effect */
    .songbook-box-inner:hover::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Firefox hover color */
    .songbook-box-inner:hover {
      scrollbar-color: rgba(255, 255, 255, 0.25) transparent;
    }

    /* Smooth fade-out when not hovered */
    .songbook-box-inner:not(:hover)::-webkit-scrollbar-thumb {
      transition: opacity 0.8s ease, background 0.3s ease;
      opacity: 0;
    }

    /* Song Titles */
    .songbook .songtitle {
      font-family: "Segoe UI", sans-serif;
      font-size: 1em;
      margin: 10px;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: normal;
      padding: 5px;
      color: white;
      user-select: none;
      cursor: pointer;
    }
  
    /* SongBook search bar */
    .songbook-search {
      padding: 10px 5px;
      margin-bottom: 5px;
    }
  
    #songbookSearchWrapper {
      display: none; /* hidden by default */
    }
  
    .songbook-search input {
      width: 100%;
      padding: 10px;
      text-align: center;
      border-radius: 20px;
      background: black;
      color: white;
      outline: none;
      box-shadow: 0 0 5px #222;
      cursor: pointer;
    }
    .songbook-search input::placeholder {
      color: grey;
      text-align-last: center;
    }
  
    /* Hide Scrollbar for WebKit Browsers */
    .next-box::-webkit-scrollbar {
      display: block;
    }
  
    /* Hover effect */
    .songbook-search input:hover {
      box-shadow:
        0 0 10px 0.5px var(--btn-glow, #222);     /* outer glow */
    }
  
    .songbook-search input::placeholder {
      color: grey;
      text-align-last: center;
    }
  
/*  ===============================
    SongBook Deletion Animation
    =============================== */
    .songbook .songtitle.removing {
      opacity: 0;
      transform: translateX(50px); /* slide out to the right */
      transition:
        opacity 0.6s ease,
        transform 0.6s ease;
    }
  
/*  ===============================
    SongBook Ripple Overlay
    ============================== */
    .songbook .songtitle {
      position: relative; /* needed for ripple */
      overflow: hidden;   /* hide ripple overflow */
    }
  
    .songbook .songtitle::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(128, 128, 128, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
  
    /* Triggered on Reserve click */
    .songbook .songtitle.ripple::after {
      opacity: 1;
      transition: opacity 0s;
    }
  
    /* Hover flash */
    .songbook .songtitle.hover-flash::after {
      opacity: 1;
      transition: opacity 0.5s ease;
    }
  
    /* Right-click (Delete Prep Highlight) */
    .songbook .songtitle.long-pressing {
      background-color: rgba(255, 0, 0, 0.25) !important;
      color: #ff4c4c !important;
      transition: background-color 0.3s ease !important;
    }
</style>

<style>
/* ==================================================================================================== */

/* Authentication Overlay ======= */
    #authOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(#006c6c, black);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 8888;
      padding: 18px; /* prevent overflow on small screens */
    }

    /* box */
    .authCard {
      width: 100%;
      min-width: 250px;
      max-width: 400px;      /* fit smaller screens */
      padding: 4%;
      background: linear-gradient(to bottom, rgba(13, 14, 14, 0.6) 0%, #000000 100%);
      border-radius: 20px;
      color: #fff;
      text-align: center;
      border: 1px solid var(--btn-glow, cyan);
      box-shadow:
        0 0 15px 2px var(--btn-glow, cyan),
        inset 0 0 10px 0.5px var(--btn-glow, #00cece);
      box-sizing: border-box;
    }

    /* title */
    .authCard h2 {
      font-family: "Orbitron", sans-serif;
      color: #91f7f7;
      margin-bottom: 50px;
    }
  
    .authcard-note {
      margin: 30px 0px;
      font-size: 0.8em;
      color: #989898;
    } 

    /* input group for floating label */
    .inputGroup {
      position: relative;
      margin: 35px 0px;
      text-align: center;
    }

    .inputGroup input {
      width: 100%;
      max-width: 100%;
      padding: 10px 15px;
      background: transparent;
      border: 1px solid var(--btn-glow, rgba(255,255,255,0));
      border-radius: 5px;
      font-size: 1em;
      color: white;
      box-shadow: 0 0 10px 0.5px var(--btn-glow, #222);
      box-sizing: border-box;
    }
    .inputGroup input:hover {
      box-shadow: 0 0 10px 0.5px var(--btn-glow, #696969);
    }

    /* floating label */
    .inputGroup label {
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      color: #505050;
      font-size: 0.85em;
      pointer-events: none;
      transition: all 0.2s ease;
      background: transparent;
      backdrop-filter: blur(6px);      /* blur effect */
      padding: 5px;
      border-radius: 5px;
    }

    .inputGroup input:focus + label,
    .inputGroup input:not(:placeholder-shown) + label {
      top: -15px;                /* move above input */
      left: 20px;
      font-size: 0.80em;         /* smaller font */
      color: #cdcdcd;              /* text color */
      background: transparent;    /* remove background when floating */
      padding: 0;                /* remove padding */
    }

    /* Register/Login button */
    .authCard button {
      padding: 10px;
      border: none;
      border-radius: 30px;
      background: #ff5fff;
      color: white;
      cursor: pointer;
      margin: 0px 0;
      transition: all 0.2s;
      font-size: 1em;
      width: 60%;
      box-sizing: border-box;
    }
    .authCard button:hover { background: #ff2fff; }
    .authCard button:active {
      transform: scale(0.90);
      background: var(--btn-glow, magenta);
      color: #ffffff;
      transition: transform 0.15s, box-shadow 0.15s;
    }
  
    /* Default: all inputs normal */
    .authCard .inputGroup {
      opacity: 1;
      transition: opacity 0.2s ease;
    }

    /* When any input inside the card is focused ‚Üí dim all */
    .authCard:focus-within .inputGroup {
      opacity: 0.5;
    }

    /* But keep the focused one at full opacity */
    .authCard .inputGroup:focus-within {
      opacity: 1;
    }

    /* underline toggle text */
    .authToggle {
      margin-top: 30px;
      font-size: 0.9em;
      color: #989898;
      cursor: pointer;
    }
  
    .passwordGroup {
      position: relative;
    }

    .passwordGroup input {
      padding-right: 35px; /* make space for the icon */
    }

    .toggle-eye {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      cursor: pointer;
      font-size: .8em;
      transition: color 0.2s;
    }

    .toggle-eye:hover {
      color: #333;
    }

    /* Portrait & Landscape adjustments */
    @media (max-width: 768px) {
      .authCard {
        width: 90%;       /* fit better in landscape */
        padding: 10%;
      }
    }

    @media (orientation: landscape) and (max-height: 480px) {
      .authCard h2 {
        margin-bottom: 40px;
        font-size: 20px;
      }
      
      .inputGroup {
        margin: 25px 0px;
      }
      
      .authCard {
        height: 100%;
        padding: 25px 50px;
      }

      .inputGroup input,
      .authCard button{
        padding: 5px 15px;
      }
      
      .authToggle {
        margin: 14px 0px;
      }
    }
/*  =============================
    Custom Alert 
    ============================== */ 
    .alert-container {
      position: fixed;
      top: 80%;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      display: flex;
      flex-direction: column;
      gap: 10px;       /* spacing between alerts */
      align-items: center;
      z-index: 99999;
    /* delete "background" to use Variants - background color */
      background: none;
    }
    
    /* Individual alert (same style as before) */
    .custom-alert {
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      background-color: rgba(0, 0, 0, 0.6);
    }
    
    .custom-alert.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Variants - how to use: Ex. showAlert("‚ùå Invalid UserID or Password", "error"); 
    .custom-alert.success { background: #28a745; }
    .custom-alert.error   { background: #dc3545; }
    .custom-alert.info    { background: #007bff; } */

      

/* Main CueTube UI hidden initially ======= */
    #mainCueTubeUI { display: none; }
</style>

</head>
  <body ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" onclick="handleTap(event)">
    
    
<!-- =============================
Authentication Overlay
============================== -->
<div id="authOverlay">
  
  <!-- Login Card -->
  <div class="authCard" id="loginCard" style="display:none;">
    <h2>Login</h2>

    <div class="inputGroup">
      <input type="text" id="loginUser" placeholder=" " required>
      <label for="loginUser">User ID</label>
    </div>

    <div class="inputGroup passwordGroup">
      <input type="password" id="loginPass" placeholder=" " required>
      <label for="loginPass">Password</label>
      <i class="fa fa-eye toggle-eye" onclick="togglePassword('loginPass', this)"></i>
    </div>

    <button onclick="loginUser()">Login</button>
    <div class="authToggle" onclick="toggleAuth()">Don't have an account? <u><b>Register</b></u></div>
  </div>
  
  <!-- Register Card -->
  <div class="authCard" id="registerCard">
    <h2>Register</h2>
    <div class="authcard-note"><b>Note:</b> User ID is used for receiving songs.</div>

    <div class="inputGroup">
      <input type="text" id="regUser" placeholder=" " maxlength="5" required>
      <label for="regUser">User ID &nbsp;&nbsp;(3-5 characters)</label>
    </div>

    <div class="inputGroup">
      <input type="text" id="regNick" placeholder=" " maxlength="10" required>
      <label for="regNick">Nickname &nbsp;&nbsp;(3-10 characters)</label>
    </div>

    <div class="inputGroup passwordGroup">
      <input type="password" id="regPass" placeholder=" " required>
      <label for="regPass">Password &nbsp;&nbsp;(min. 5 characters)</label>
      <i class="fa fa-eye toggle-eye" onclick="togglePassword('regPass', this)"></i>
    </div>

    <button onclick="registerUser()">Register</button>
    <div class="authToggle" onclick="toggleAuth()">Already have an account? <u><b>Login</b></u></div>
  </div>
</div>

<!-- ============================
Main CueTube UI
============================== -->
    <!-- Alert -->
    <div id="alertContainer" class="alert-container"></div>
    
<div id="mainCueTubeUI">

    <!-- Invisible touchpad -->
    <div class="touchpad"></div>
  
    <!-- Title -->
    <div class="title-bar">
      <img src="CueTube Icon.png" class="title-icon" alt="CueTube Icon" />
      <span class="title-text">BRD Christmas Party!</span>
    </div>
  
<!-- Drawer -->
<div class="drawer" id="drawer">
  <div id="drawerHandle" class="drawer-handle" onclick="toggleDrawer()">‚ò∞</div>
      
      <div class="main-group">
<!-- Group A -->
        <div class="group-a">
          <!-- Now Playing stays fixed -->
          <div class="nowplaying-box">
            <div class="label">Now Playing :</div>
            <div class="title" id="nowTitle"></div>
          </div>
          <!-- Next list with smooth stretch -->
          <div class="next-box hidden">
            <div class="next-box-inner">
              <div class="label">NEXT</div>
              <div id="nextList"></div>
              <div id="overflowCounter"></div>
            </div>
          </div>
        </div>
<!-- Group B -->
      <div class="group-b">
        <!-- SongBook -->
        <div class="songbook" id="songbook">
          <div class="songbook-handle" onclick="toggleSongbook()">Songbook üéµ</div>

          <div class="songbook-search" id="songbookSearchWrapper">
            <input type="text" id="songbookSearch" placeholder="Search Songs" onkeyup="filterSongbook()" />
          </div>

          <div class="songbook-list">
            <!-- Scrollable inner like NextBox -->
            <div class="songbook-box">
              <div class="songbook-box-inner">
                <div id="songbookList"></div>
                <div id="noResults" style="display:none; font-family: Segoe UI, sans-serif; font-size: 1em; color: white; text-align: center;">" No results found "</div>
              </div>
            </div>
          </div>
        </div>
      </div>
        
    </div>    <!-- end of Main Group -->
</div>    <!-- end of Drawer -->
  
  
    <!-- Overlays -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="bot-drawer-overlay" id="bottomDrawerOverlay" onclick="closeBottomDrawer()"></div>
  
    <!-- Notify -->
    <div class="notify-box">
      <div id="nowPlayingCopy"></div>
    </div>
    <!-- YouTube Player -->
    <div class="youtube-wrapper">
      <iframe
        id="player"
        src="https://www.youtube.com/embed/?enablejsapi=1&controls=1&autoplay=1&rel=0&modestbranding=1"
        allowfullscreen></iframe>
    </div>
  
    <!-- Bottom Drawer -->
    <div class="bottom-drawer" id="bottomDrawer">
      <button class="bottom-drawer-handle" onclick="toggleBottomDrawer()">_</button>
      
      <div class="url-group">
        <input type="text" class="url-input" placeholder="Paste YouTube URL here" id="youtubeInputDrawer" />
        
        <button id="pasteBtn" class="paste-btn-icon" data-tooltip="Paste (Ctrl + V)">
          <img src="Paste Icon.png" alt="Paste" class="paste-icon-image" />
        </button>
      </div>
      
      <div class="bottom-buttons">
        <button class="cyan-btn" data-tooltip="Reserve to queue" onclick="reserveFromDrawer()">Reserve</button>
        <button class="cyan-btn" data-tooltip="Save to songbook" onclick="saveToSongbook()">Save</button>
        <button id="nextBtnDrawer" class="cyan-btn" data-tooltip="Next Song (Ctrl + ‚Üí)" onclick="showNextConfirm()">
          Next
        </button>
      </div>
    </div>
    

    <!-- Popup -->
    <div id="popupOverlay"></div>
    <div id="popupModal"></div>
  
    <!-- Generic Overlay -->
    <!-- Overlay -->
    <div id="genericOverlay" class="overlay" style="display: none"></div>
  
    <!-- Modal -->
    <div id="genericModal" class="modal" style="display: none">
      <div class="modal-content" id="genericContent">
        <!-- Dynamic content is injected by showModal(...) -->
      </div>
    </div>
  
    <audio id="clickSound" src="click.wav" preload="auto"></audio>
    <audio id="successSound" src="success.wav" preload="auto"></audio>
    <audio id="errorSound" src="error.wav" preload="auto"></audio>
    <audio id="trashSound" src="trash.wav" preload="auto"></audio>
    <audio id="slideSound" src="slide.wav" preload="auto"></audio>
    <audio id="notifSound" src="notif.wav" preload="auto"></audio>
  
  
</div>

<!-- =============================
JavaScript Logic
============================== -->
<script>
  
    function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }
    //  ==============================
    //  Drawer & Overlay Setup
    //  ==============================
    let overlayTouchStartX = 0;
    let isLeftOverlayOpen = false;
    let touchStartX = 0;

    // Drawer elements
    const drawer = document.getElementById("drawer");
    addRubberBandEffect(drawer, "left", 70, 0.25); // Left drawer rubber-band
    const bottomDrawer = document.getElementById("bottomDrawer");
    addRubberBandEffect(bottomDrawer, "bottom", 15, 0.0);
    const overlay = document.getElementById("drawerOverlay"); // Bottom drawer rubber-band
    const popupOverlay = document.getElementById("popupOverlay");


    //  ==============================
    //  Touch Handlers
    //  ==============================
    // Track initial X position when touch starts
    function handleTouchStart(evt) {
      touchStartX = evt.touches[0].clientX;
    }

    // Track movement to swipe left/right for drawer
    function handleTouchMove(evt) {
      const deltaX = evt.touches[0].clientX - touchStartX;
      if (deltaX > 50) openDrawer();
      else if (deltaX < -50) closeDrawer();
    }

    // Tap outside left drawer closes it
    function handleTap(evt) {
      if (!drawer.contains(evt.target) && drawer.classList.contains("open")) {
        closeDrawer();
      }
    }

    //  ==============================
    //  Drawer Toggle Functions
    //  ==============================
    function toggleDrawer() {
      if (drawer.classList.contains("open")) closeDrawer();
      else openDrawer();
    }

    // Open left drawer
    function openDrawer() {
      // Close bottom drawer if open
      if (bottomDrawer.classList.contains("open")) {
        bottomDrawer.classList.remove("open");
        document.querySelector(".bottom-drawer-handle").style.display = "flex";
      }

      drawer.classList.add("open");
      overlay.classList.add("visible");
      isLeftOverlayOpen = true;
      document.getElementById("drawerHandle").style.display = "none";
    }

    // Close left drawer
    function closeDrawer() {
      if (!drawer.classList.contains("open") || isModalOpen) return;

      drawer.classList.remove("open");
      drawerOverlay.classList.remove("visible");
      isLeftOverlayOpen = false;
      document.getElementById("drawerHandle").style.display = "flex";

      document.activeElement.blur();
      document.body.focus();
    }

    function closeBottomDrawer() {
      if (!bottomDrawer.classList.contains("open") || isModalOpen) return;

      bottomDrawer.classList.remove("open");
      document.querySelector(".bottom-drawer-handle").style.display = "flex";
      bottomDrawerOverlay.classList.remove("visible");

      document.activeElement.blur();
      document.body.focus();
    }

    //  ==============================
    //  Swipe to Close Left Drawer
    //  ==============================
    drawerOverlay.addEventListener("touchstart", (e) => {
      if (isModalOpen) return; // disable swipe if modal is up
      overlayTouchStartX = e.touches[0].clientX;
    });

    drawerOverlay.addEventListener("touchmove", (e) => {
      if (isModalOpen) return;
      const deltaX = e.touches[0].clientX - overlayTouchStartX;
      if (deltaX < -50) closeDrawer(); // swipe left to close
    });

    //   =====================
    //   Bottom Drawer Toggle
    //   =====================
    function toggleBottomDrawer() {
      const isOpen = bottomDrawer.classList.toggle("open");
      document.querySelector(".bottom-drawer-handle").style.display = isOpen ? "none" : "flex";
      bottomDrawerOverlay.classList.toggle("visible", isOpen);

      if (isOpen) {
        // Close left drawer if open
        if (drawer.classList.contains("open")) {
          drawer.classList.remove("open");
          drawerOverlay.classList.remove("visible");
          document.getElementById("drawerHandle").style.display = "flex";
        }
      } else {
        bottomDrawerOverlay.classList.remove("visible");
      }
    }

    //   ===========================================
    //   Click on bottom overlay closes drawers
    //   ===========================================
    bottomDrawerOverlay.onclick = function () {
      if (isModalOpen) return; // don‚Äôt close drawers if modal is open
      if (drawer.classList.contains("open")) closeDrawer();
      if (bottomDrawer.classList.contains("open")) closeBottomDrawer();
    };

    //   ===============================
    //   Smooth Stretch Overscroll
    //   ===============================
    (function smoothStretchScroll() {
      const box = document.querySelector(".next-box");
      const inner = box.querySelector(".next-box-inner");
      if (!box || !inner) return;

      let startY = 0;
      let isTouching = false;
      let pulling = false;
      const maxStretch = 60; // px

      // Touch start
      box.addEventListener(
        "touchstart",
        (e) => {
          startY = e.touches[0].clientY;
          isTouching = true;
          pulling = false;
          inner.style.transition = ""; // cancel smooth return during drag
        },
        { passive: true }
      );

      // Touch move
      box.addEventListener(
        "touchmove",
        (e) => {
          if (!isTouching) return;

          const currentY = e.touches[0].clientY;
          const deltaY = currentY - startY;
          const maxScroll = box.scrollHeight - box.clientHeight;

          if ((box.scrollTop <= 0 && deltaY > 0) || (box.scrollTop >= maxScroll && deltaY < 0)) {
            const stretch = Math.max(-maxStretch, Math.min(deltaY / 2, maxStretch));
            inner.style.transform = `translateY(${stretch}px)`;
            pulling = true;
            e.preventDefault(); // stop native glow overscroll
          }
        },
        { passive: false }
      );

      // Touch end
      box.addEventListener("touchend", () => {
        if (pulling) {
          inner.style.transition = "transform 0.3s ease";
          inner.style.transform = "translateY(0)";
        }
        isTouching = false;
        pulling = false;
      });
    })();

    //  ======================================================
    //  GLOBAL VERTICAL SWIPE: Bottom Drawer Handling
    //  ======================================================
    let startY = 0;
    document.body.addEventListener("touchstart", (evt) => {
      startY = evt.touches[0].clientY;
      handleTouchStart(evt); // üõë your existing left/right swipe start
    });

    document.body.addEventListener("touchmove", (evt) => {
      const deltaY = evt.touches[0].clientY - startY;

      // üö´ Ignore if inside .next-box (so bounce handles it instead)
      if (evt.target.closest(".next-box")) {
        return;
      }

      if (isLeftOverlayOpen) {
        if (deltaY > 40) closeBottomDrawer(); // üõë swipe down closes bottom drawer
        return; // prevent bottom drawer while left is open
      }

      if (deltaY < -40 && !bottomDrawer.classList.contains("open")) {
        toggleBottomDrawer(); // üõë swipe up to open bottom drawer
      } else if (deltaY > 40) {
        closeBottomDrawer(); // üõë swipe down always closes
      }

      handleTouchMove(evt); // üõë your existing left/right swipe move
    });

    //  ==============================
    //  Keyboard Shortcuts
    //  ==============================
    document.addEventListener("keydown", async (e) => {
      // Ignore shortcuts when typing in input or textarea
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;

      // Always allow ESC to close modal
      if (e.key === "Escape" && isModalOpen) {
        hideModal(); // generic modal handles hiding
        return;
      }

      // Block drawer shortcuts if modal is open
      if (isModalOpen) return;

      // Ctrl+V / Cmd+V: Paste from clipboard ‚Üí auto-reserve
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "v") {
        e.preventDefault();
        await pasteFromClipboard();
        return;
      }


      // Ctrl+S / Cmd+S ‚Üí Save to Songbook 
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();

        const urlInput = document.getElementById("youtubeInputDrawer");

        // Case 1: Use whatever is in the input
        if (urlInput && urlInput.value.trim() !== "") {
          saveToSongbook();
          playSuccessSound();
          showPopup("Saved!", "cyan", true, "cyan");
          return;
        }

        // Case 2: If input empty but a video is playing, auto-fill and save
        if (queue.length > 0 && currentIndex >= 0) {
          const currentSong = queue[currentIndex];
          urlInput.value = `https://www.youtube.com/watch?v=${currentSong.id}`;
          saveToSongbook();
          playSuccessSound();
          showPopup("Saved!", "cyan", true, "cyan");
          return;
        }

        // Case 3: Nothing to save
        playErrorSound();
        showPopup("‚ö†Ô∏è No copied URL to save", "red", true, true);
      }


      // Ctrl + Right Arrow ‚Üí Next button
      if (e.ctrlKey && e.key === "ArrowRight") {
        e.preventDefault();
        const nextBtnDrawer = document.getElementById("nextBtnDrawer");
        if (nextBtnDrawer) nextBtnDrawer.click();
        return;
      }

      // Drawer controls
      if (e.key === "ArrowUp") toggleBottomDrawer();
      if (e.key === "ArrowDown") closeBottomDrawer();
      if (e.key === "ArrowRight") openDrawer();
      if (e.key === "ArrowLeft") closeDrawer();

      // ESC closes everything if no modal
      if (e.key === "Escape") {
        closeDrawer();
        closeBottomDrawer();
      }

      // Spacebar: Play / Pause YouTube video
      if (e.code === "Space") {
        e.preventDefault(); // prevent page scroll
        if (player && player.getPlayerState) {
          if (player.getPlayerState() === YT.PlayerState.PLAYING) {
            player.pauseVideo();
          } else {
            player.playVideo();
          }
        }
      }

      // Enter: confirm active modal
      if (e.key === "Enter" && isModalOpen) {
        // Trigger the first button in the modal
        const firstBtn = document.getElementById("genericContent")?.querySelector("button");
        if (firstBtn) firstBtn.click();
        e.preventDefault();
      }
    });
  

      // Enter: Login/Register Button
      document.querySelectorAll("#loginCard input").forEach(input => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            loginUser();
          }
        });
      });

      document.querySelectorAll("#registerCard input").forEach(input => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            registerUser();
          }
        });
      });
  
  
    //  ==============================
    //  URL Input Enter Key
    //  ==============================
    document.getElementById("youtubeInputDrawer").addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault(); // prevent form submission / page refresh
        reserveFromDrawer(); // trigger reserve function
      }
    });

    //  ==============================
    //  Body click handler
    //  ==============================
    document.body.addEventListener("click", handleTap);

    //  ==============================
    //  YouTube Player Setup
    //  ==============================
    let player;
    let queue = [];
    let currentIndex = -1;

    if (typeof YT === "undefined" || typeof YT.Player === "undefined") {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        events: {
          onReady: () => console.log("Player Ready"),
          onStateChange: onPlayerStateChange
        },
        origin: window.location.origin
      });
    }

    //  =====================
    //  Touchpad Play/Pause
    //  =====================
    document.addEventListener("DOMContentLoaded", () => {
      const touchpad = document.querySelector(".touchpad");
      if (!touchpad) return;

      touchpad.addEventListener("click", () => {
        if (!player) return;
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      });
    });

      let pauseTimeout = null;

      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
          const isLastVideo = currentIndex === queue.length - 1;
          if (queue.length === 0 || isLastVideo) {
            hideNotify();
            queue = [];
            currentIndex = -1;

            updateNowPlaying();
            updateQueueDisplay();

            player.stopVideo();
            player.clearVideo();
            
            playNotifSound();
            showPopup("That's the last tune!", "magenta", true, true);
          } else {
            currentIndex++;
            player.loadVideoById(queue[currentIndex].id);
            updateNowPlaying();
            updateQueueDisplay();
          }
        } else if (event.data === YT.PlayerState.PAUSED) {
          playClickSound();
          pauseTimeout = setTimeout(() => {
            showPopup("II Paused", "magenta", true, true);
          }, 300);
          stopProgressChecker();
        } else if (event.data === YT.PlayerState.PLAYING) {
          clearTimeout(pauseTimeout);
          clearPersistentPopup();
          startProgressChecker();
        } else {
          stopProgressChecker();
        }
      }

    // =====================
    // Extract Video ID (supports standard, shortened, embed URLs)
    // =====================
    function extractVideoId(url) {
      if (!url) return null;

      // Remove extra parameters
      const cleanUrl = url.split("&")[0];

      // Match standard, shortened, or embed URLs
      const regex = /(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([0-9A-Za-z_-]{11})/;
      const match = cleanUrl.match(regex);
      return match ? match[1] : null;
    }

    // =====================
    // Song Fetch: Title
    // =====================
    let invalidSongCount = 0; // counter for invalid/untitled songs

    function resetInvalidSongCounter() {
      invalidSongCount = 0;
    }

    async function fetchTitle(videoId) {
      try {
        const res = await fetch(
          `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`
        );

        if (!res.ok) throw new Error("Failed to fetch video info");

        const data = await res.json();

        // Return title only, or Invalid Song with numbering
        return data.title || `Invalid Song ${++invalidSongCount}`;
      } catch (err) {
        invalidSongCount++;
          playErrorSound();
          setTimeout(() => {
          showPopup("‚ö†Ô∏è Oops! Try choosing another video", "red", true, true);
        }, 500);
        return `Invalid Song ${invalidSongCount}`;
      }
    }

    // =====================
    // Reserve Video from Drawer
    // =====================
    async function reserveFromDrawer() {
      clearPersistentPopup();

      const result = validateYouTubeInput("youtubeInputDrawer");
      if (!result) return; // stop if invalid

      const { input, videoId } = result;
      const title = await fetchTitle(videoId);

      if (title.startsWith("Invalid Song")) {
        input.value = "";
        return;
      }

      // Auto-play if queue empty
      if (queue.length === 0 && currentIndex === -1) {
        queue.push({ id: videoId, title });
        currentIndex = 0;
        player.loadVideoById(videoId);
        player.playVideo();
        updateNowPlaying();
      } else {
        queue.push({ id: videoId, title });
      }

      updateQueueDisplay();
      input.value = "";

      if (!persistentPopupActive) {
        playSuccessSound();
        setTimeout(() => {
          showPopup("Reserved!", "cyan", false, "cyan");
        }, 500);
        setTimeout(() => {
          showAlert("‚úÖ New Song added to Queue", "success");
        }, 1800);
      }
      closeBottomDrawer();
    }

    // =====================
    // Common: Validate URL
    // =====================
    function validateYouTubeInput(inputId) {
      const input = document.getElementById(inputId);
      const url = input.value.trim();

      // Empty input
      if (!url) {
        playErrorSound();
        setTimeout(() => {
          showPopup("‚ö†Ô∏è Please paste a URL first", "red", true, true);
        }, 500);
        return null;
      }

      // Extract Video ID
      const videoId = extractVideoId(url);
      if (!videoId) {
        input.value = "";
        playErrorSound();
        setTimeout(() => {
          showPopup("‚ö†Ô∏è Invalid Youtube URL!", "red", true, true);
        }, 500);
        return null;
      }

      return { input, url, videoId };
    }

    // =====================
    // Play Next from Queue
    // =====================
    function playNextFromQueue() {
      playClickSound();
      if (queue.length === 0 || currentIndex + 1 >= queue.length) {
        playErrorSound();
        setTimeout(() => {
          showPopup("Queue is Empty!", "red", true, true);
        }, 500);
        return;
      }

      currentIndex++;
      player.loadVideoById(queue[currentIndex].id);
      updateNowPlaying();
      updateQueueDisplay();

      setTimeout(() => {
        showPopup("Next!", "cyan", false, "cyan"); playSuccessSound();
      }, 500);
    }

// =====================
// Queue Display
// =====================
function updateQueueDisplay() {
  const list = document.getElementById("nextList");
  const overflow = document.getElementById("overflowCounter");
  list.innerHTML = "";

  // ----- Loop all upcoming songs -----
  for (let i = currentIndex + 1; i < queue.length; i++) {
    const div = document.createElement("div");
    div.className = "songtitle";
    div.textContent = queue[i].title;
    div.style.cursor = "pointer";

    // ---------- (A) Single Click ----------
    div.addEventListener("click", () => {
      div.classList.add("ripple");
      setTimeout(() => div.classList.remove("ripple"), 500);
      openQueueSongOptions(queue[i], div, i);
    });

    // ---------- (B) Hover Flash ----------
    div.addEventListener("mouseenter", () => {
      div.classList.add("hover-flash");
      setTimeout(() => div.classList.remove("hover-flash"), 500);
    });

    // ---------- (C) Right-Click ----------
    div.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      openQueueSongOptions(queue[i], div, i);
    });

    // ----- Add to list -----
    list.appendChild(div);
  }

  // ----- Update overflow counter -----
  updateOverflowCounter();

  // ----- Enable/disable next button -----
  const nextBtn = document.getElementById("nextBtnDrawer");
  const hasNext = queue.length > 0 && currentIndex + 1 < queue.length;
  nextBtn.disabled = !hasNext;
  nextBtn.style.opacity = hasNext ? "1.0" : "0.4";
  nextBtn.style.cursor = hasNext ? "pointer" : "not-allowed";

  // ----- Show/hide next box -----
  const nextBox = document.querySelector(".next-box");
  const upcomingCount = queue.length - (currentIndex + 1);
  if (upcomingCount >= 1) {
    nextBox.classList.remove("hidden");
  } else {
    nextBox.classList.add("hidden");
  }
}

// =====================
// Overflow Counter
// =====================
function updateOverflowCounter() {
  const list = document.getElementById("nextList");
  const overflow = document.getElementById("overflowCounter");
  if (!list || !overflow) return;

  const totalHeight = list.scrollHeight;
  const visibleHeight = list.clientHeight;
  const scrollable = totalHeight > visibleHeight;

  if (scrollable) {
    const items = list.children;
    let shown = 0;
    let accHeight = 0;
    for (let i = 0; i < items.length; i++) {
      accHeight += items[i].offsetHeight;
      if (accHeight < visibleHeight) shown++;
    }
    const remainingCount = items.length - shown;
    overflow.innerText = `${remainingCount} more song${remainingCount > 1 ? "s" : ""}`;
    overflow.style.display = "block";
  } else {
    overflow.style.display = "none";
  }
}

// =====================
// Queue Song Options Modal
// =====================
function openQueueSongOptions(song, target, index) {
  showModal({
    glowColor: "cyan",
    title: "QUEUE OPTIONS",
    titleColor: "cyan",
    messages: [
      { text: `"${song.title}"`, color: "white", style: "font-family: 'Segoe UI', sans-serif" }
    ],
    buttons: [
      // ---------- (1) DELETE ----------
    {
      label: "Remove",
      onClick: () => {
        playClickSound();
        __modal_onClose = () => {
          showModal({
            glowColor: "red",
            title: "REMOVE ?",
            titleColor: "red",
            messages: [{ text: `"${song.title}"`, color: "white" }],
            buttons: [
              {
                label: "Confirm",
                onClick: () => {
                  // üîä Play trash sound agad
                  playTrashSound();

                  // üé¨ Trigger animation
                  target.classList.add("removing");

                  // ‚è≥ Wait 600ms bago tanggalin sa queue at i-refresh
                  setTimeout(() => {
                    queue.splice(index, 1); // remove song from queue
                    updateQueueDisplay();
                    showPopup("Removed!", "red", false, true);
                  }, 600); // match CSS transition time
                }
              },
              {
                label: "Cancel",
                onClick: () => playClickSound()
              }
            ]
          });
        };
      }
    },
    // ---------- (2) PLAY NOW ----------
    {
      label: "Play",
      onClick: () => {
        playClickSound();
        __modal_onClose = () => {
          showModal({
            glowColor: "cyan",
            title: "PLAY NOW ?",
            titleColor: "cyan",
            messages: [
              { text: `"${song.title}"`, color: "white", style: "font-family: 'Segoe UI', sans-serif" },
              { text: "Note: The current song will be skipped.", color: "gray" }
            ],
            buttons: [
              {
                label: "Confirm",
                onClick: () => {
                  playClickSound();
                  // Remove the chosen song from its current position
                  const [chosenSong] = queue.splice(index, 1);

                  // Insert it right after the currentIndex
                  queue.splice(currentIndex + 1, 0, chosenSong);

                  // Advance to it
                  currentIndex++;
                  player.loadVideoById(chosenSong.id);
                  player.playVideo();

                  updateNowPlaying();
                  updateQueueDisplay();
                  
                  setTimeout(() => {
                  showPopup("Now Playing!", "cyan", false, true); playSuccessSound();
                }, 500);
                }
              },
              {
                label: "Cancel",
                onClick: () => playClickSound()
              }
            ]
          });
        };
      }
    }
    ],
    showCloseButton: true
  });
}

// =====================
// Init when ready
// =====================
document.addEventListener("DOMContentLoaded", () => {
  updateQueueDisplay();
});

    // =====================
    // Notify Animation & Now Playing
    // =====================
    let progressChecker = null;
    let nextSongNotifyShown = false;

    // Track notify timers
    let notifyShowTimeout = null;
    let notifyHideTimeout = null;

    // =====================
    // Update Now Playing Box
    // =====================
    function updateNowPlaying() {
      const nowTitleEl = document.getElementById("nowTitle");
      const nowBoxEl = document.querySelector(".nowplaying-box");
      const labelEl = nowBoxEl.querySelector(".label");
      const current = queue[currentIndex];

      if (!player || typeof player.getCurrentTime !== "function") {
        stopProgressChecker();
      }

      // Cancel any pending notify timers
      if (notifyShowTimeout) {
        clearTimeout(notifyShowTimeout);
        notifyShowTimeout = null;
      }
      if (notifyHideTimeout) {
        clearTimeout(notifyHideTimeout);
        notifyHideTimeout = null;
      }

      if (!current) {
        nowTitleEl.innerHTML = "";
        labelEl.textContent = "Now Playing :";
        nowBoxEl.classList.remove("active"); // üîπ remove glow + label highlight
        stopProgressChecker();
        return;
      }

      let title = current.title || `Video ID: ${current.id}`;
      let remaining = queue.length - (currentIndex + 1);

      // üîπ add active state so box + label glow
      nowBoxEl.classList.add("active");

      if (remaining === 0) {
        // No upcoming song
        nowTitleEl.innerHTML = `
          <span class="now-playing-glow">${title}</span>
          <div id="noUpcoming"
            style="color: darkcyan;
            font-family: 'Segoe UI', sans-serif;
            font-weight: normal;
            margin-top: 10px;
            font-size: 1em;">
            No upcoming song . . .
          </div>`;

        labelEl.textContent = "Now Playing :"; // keep label updated

        notifyShowTimeout = setTimeout(() => {
          showNotify("No upcoming song");

          notifyHideTimeout = setTimeout(() => {
            hideNotify();
          }, 10000);
        }, 10000);

        stopProgressChecker();
      } else {
        // Update the title with glow
        nowTitleEl.innerHTML = `<span class="now-playing-glow">${title}</span>`;
        labelEl.textContent = "Now Playing :"; // keep label updated
        hideNotify();
        removeNoUpcoming(); // Remove "No upcoming song" immediately
        startProgressChecker();
      }
    }


    // =====================
    // Remove "No upcoming song" text
    // =====================
    function removeNoUpcoming() {
      const noUpcomingEl = document.getElementById("noUpcoming");
      if (noUpcomingEl) {
        noUpcomingEl.remove();
      }
    }

    // =====================
    // Notify helper functions
    // =====================
    function showNotify(message) {
      hideNotify(); // remove any existing notify first
      document.getElementById("nowPlayingCopy").innerHTML = `
  <div class="Notify">
    <div class="line"></div>
    <div class="text">${message}</div>
  </div>
`;
      playNotifSound(); // üîä play sound exactly when shown
    }

    function showTempNotify(message) {
      showNotify(message); // sound plays here
      setTimeout(() => hideNotify(), 10000); // auto-hide after 10s
    }

    function hideNotify() {
      const notifyEl = document.querySelector(".Notify");
      if (notifyEl) {
        playSlideSound(); // üîä play sound right when hide starts
        notifyEl.classList.add("hide");
        setTimeout(() => notifyEl.remove(), 1500); // remove after animation
      }
    }

    // =====================
    // Progress checking for "Up next"
    // =====================
    function startProgressChecker() {
      if (progressChecker) return; // already running
      nextSongNotifyShown = false;
      progressChecker = setInterval(() => {
        if (!player || typeof player.getCurrentTime !== "function") {
          return; // üö´ skip if player not ready
        }

        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();

        if (!nextSongNotifyShown) {
          const shown = scheduleNextSongNotify(duration, currentTime);
          if (shown) nextSongNotifyShown = true;
        }
      }, 1000);
    }

    function stopProgressChecker() {
      clearInterval(progressChecker);
      progressChecker = null;
    }

    function scheduleNextSongNotify(duration, currentTime) {
      const secondsBeforeEnd = 20; // how early to show upnext
      const timeRemaining = duration - currentTime;

      if (timeRemaining <= secondsBeforeEnd && queue[currentIndex + 1]) {
        const nextSongTitle = queue[currentIndex + 1].title || "Untitled song";

        const messageHTML = `
        <div style="display: flex; flex-direction: column; white-space: normal; max-width: 90%;">
          <span style="
            font-family: 'Orbitron', sans-serif;
            font-weight: normal;
            font-size: 1em; 
            color: white; 
            margin-bottom: 4px;
          ">Up Next :</span>
          <span style="
            font-family: 'Segoe UI', sans-serif;
            font-weight: normal;
            font-size: 1em;
            word-wrap: break-word;
          ">${nextSongTitle}</span>
        </div>`;

        showTempNotify(messageHTML); // plays notif sound on show, slide sound on hide
        return true;
      }
      return false;
    }

    // =====================
    // Reactive Queue Proxy
    // Automatically update Now Playing whenever a song is added
    // Also removes "No upcoming song" immediately
    // =====================
    queue = new Proxy(queue, {
      get(target, prop) {
        if (prop === "push") {
          return function (...songs) {
            const result = Array.prototype.push.apply(target, songs);
            removeNoUpcoming(); // hide "No upcoming song" immediately
            updateNowPlaying(); // update glow/title/notify
            return result;
          };
        }
        return target[prop];
      },
      set(target, prop, value) {
        target[prop] = value;
        if (prop !== "length") {
          removeNoUpcoming(); // hide "No upcoming song" immediately
          updateNowPlaying();
        }
        return true;
      }
    });

    // =====================
    // PopUps
    // =====================
    let persistentPopupActive = false;

    function showPopup(message, color = "magenta", persistent = false, glow = false, delay = 0) {
      setTimeout(() => {
        const popup = document.getElementById("popupModal");
        const overlay = document.getElementById("popupOverlay");

        popup.textContent = message;
        popup.style.color = "white";
        popup.classList.remove("glow-text", "static-glow");

        if (typeof glow === "string") {
          popup.style.setProperty("--glow-color", glow);
          popup.classList.add("static-glow");
        } else if (glow === true) {
          popup.style.setProperty("--glow-color", color);
          popup.classList.add("glow-text");
        }

        overlay.classList.add("visible");
        popup.classList.add("show");

        if (persistent) {
          persistentPopupActive = true;
        } else {
          persistentPopupActive = false;
          setTimeout(() => {
            popup.classList.remove("show");
            overlay.classList.remove("visible");
          }, 800);
        }

        // üéØ Anywhere click/tap when paused will unpause
        if (message === "II Paused") {
          overlay.style.cursor = "pointer";
          overlay.onclick = () => {
            if (player && player.playVideo) {
              player.playVideo(); // resume video
            }
            clearPersistentPopup(); // hide popup
            overlay.onclick = null; // remove listener
            overlay.style.cursor = "default";
          };
        } else {
          overlay.onclick = null;
          overlay.style.cursor = "default";
        }
      }, delay);
    }

    function clearPersistentPopup() {
      if (persistentPopupActive) {
        const popup = document.getElementById("popupModal");
        const overlay = document.getElementById("popupOverlay");
        popup.classList.remove("show");
        overlay.classList.remove("visible");
        popup.classList.remove("glow-text"); // remove glow when clearing
        persistentPopupActive = false;
      }
    }

    // Tap anywhere to clear persistent popup and resume video if paused
    document.body.addEventListener("click", () => {
      if (player && player.getPlayerState() === YT.PlayerState.PAUSED && persistentPopupActive) {
        player.playVideo();
      }
      clearPersistentPopup();
    });

    // Popup Overlay Close
    document.getElementById("popupOverlay").onclick = () => {
      const popup = document.getElementById("popupModal");
      popup.classList.remove("show");
      document.getElementById("popupOverlay").classList.remove("visible");
      persistentPopupActive = false;
    };
  


    // =====================
    // Flexible Rubber Band Stretch Effect
    // for Left or Bottom Drawer
    // =====================
    function addRubberBandEffect(drawerEl, direction = "left", maxStretch = 50, thresholdPercent = 0.3) {
      let startPos = 0;
      let isDragging = false;
      let thresholdReached = false;
      let axis = direction === "left" ? "X" : "Y";

      // Set transform origin based on drawer direction
      if (direction === "left") drawerEl.style.transformOrigin = "left center";
      else if (direction === "bottom") drawerEl.style.transformOrigin = "center bottom";

      drawerEl.addEventListener("touchstart", (e) => {
        if (!drawerEl.classList.contains("open")) return;
        isDragging = true;
        thresholdReached = false;

        startPos = axis === "X" ? e.touches[0].clientX : e.touches[0].clientY;
      });

      drawerEl.addEventListener("touchmove", (e) => {
        if (!isDragging || !drawerEl.classList.contains("open")) return;

        let delta = axis === "X" ? e.touches[0].clientX - startPos : startPos - e.touches[0].clientY; // swipe up for bottom drawer

        let screenSize = axis === "X" ? window.innerWidth : window.innerHeight;
        let threshold = screenSize * thresholdPercent;

        if (delta > threshold) {
          thresholdReached = true;

          const stretch = Math.min(delta - threshold, maxStretch);
          const scale = axis === "X" ? 1 + stretch / drawerEl.offsetWidth : 1 + stretch / drawerEl.offsetHeight;

          drawerEl.style.transform = axis === "X" ? `scaleX(${scale})` : `scaleY(${scale})`;
        }
      });

      drawerEl.addEventListener("touchend", () => {
        if (!isDragging) return;
        isDragging = false;

        if (thresholdReached) {
          drawerEl.style.transition = "transform 0.15s ease-out";
          drawerEl.style.transform = axis === "X" ? "scaleX(1)" : "scaleY(1)";
          setTimeout(() => {
            drawerEl.style.transition = "";
          }, 150);
        }
      });
    }

// =====================
// Universal Tooltip
// =====================
// note: to add new tooltip use this script to html ex. <button data-tooltip="Example">Click Me</button>
// Create a single floating tooltip element
const tooltip = document.createElement("div");
tooltip.id = "universalTooltip";
Object.assign(tooltip.style, {
  position: "absolute",
  pointerEvents: "none",
  background: "#222",
  color: "#fff",
  padding: "5px 10px",
  borderRadius: "4px",
  fontFamily: "sans-serif",
  fontSize: "0.85em",
  whiteSpace: "nowrap",
  opacity: "0",
  transition: "opacity 0.2s",
  zIndex: "9999",
});
document.body.appendChild(tooltip);

document.querySelectorAll("[data-tooltip]").forEach(el => {
  let timeout;

  const showTooltip = () => {
    tooltip.textContent = el.getAttribute("data-tooltip");
    tooltip.style.opacity = "1";

    const rect = el.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();

    // Default: above element
    let top = rect.top - tooltipRect.height - 8 + window.scrollY;
    let left = rect.left + rect.width / 2 - tooltipRect.width / 2 + window.scrollX;

    // --- Adjust if off-screen horizontally ---
    if (left < 4) left = 4; // small padding from left
    if (left + tooltipRect.width > window.innerWidth - 4)
      left = window.innerWidth - tooltipRect.width - 4;

    // --- Adjust vertically if off-screen ---
    if (top < 4) top = rect.bottom + 8 + window.scrollY; // show below if not enough space above

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;
  };

  const hideTooltip = () => {
    clearTimeout(timeout);
    tooltip.style.opacity = "0";
  };

  // --- Desktop hover ---
  el.addEventListener("mouseenter", () => {
    timeout = setTimeout(showTooltip, 500);
  });
  el.addEventListener("mouseleave", hideTooltip);

  // --- Mobile long-press ---
  el.addEventListener("touchstart", e => {
    if (e.touches.length > 1) return;

    const startX = e.touches[0].clientX;
    const startY = e.touches[0].clientY;

    timeout = setTimeout(showTooltip, 700); // show after 700ms press

    const moveHandler = e2 => {
      const dx = e2.touches[0].clientX - startX;
      const dy = e2.touches[0].clientY - startY;
      if (Math.sqrt(dx*dx + dy*dy) > 10) { // finger moved >10px
        clearTimeout(timeout);
        el.removeEventListener("touchmove", moveHandler);
      }
    };

    el.addEventListener("touchmove", moveHandler, { passive: true });
  });

  el.addEventListener("touchend", hideTooltip);
  el.addEventListener("touchcancel", hideTooltip);
});

    // ======================================
    // Exit Modal
    // ======================================
    // Android/WebView Back Button Handler
    window.addEventListener("load", () => {
      history.pushState(null, document.title, location.href);
    });

    window.addEventListener("popstate", function (e) {
      showExitConfirm();
      history.pushState(null, document.title, location.href);
    });

    // PC/Browser close confirmation
    window.addEventListener("beforeunload", function (e) {
      e.preventDefault();
      e.returnValue = "";
    });

    // ======================================
    // Desktop: popup window tab
    // Mobile: YouTube app or browser fallback
    // 3s cooldown, no click animation
    // ======================================
    const titleIcon = document.querySelector(".title-icon");
    let canClick = true;

    titleIcon.addEventListener("click", () => {
      if (!canClick) return;
      canClick = false;
      titleIcon.style.pointerEvents = "none";

      const searchQuery = "karaoke";
      const youtubeSearchURL = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;

      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

      if (isAndroid) {
        // Android ‚Üí open YouTube app via intent with search
        window.location.href = `intent://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}#Intent;scheme=https;package=com.google.android.youtube;end`;
      } else if (isIOS) {
        // iOS ‚Üí open YouTube app via URL scheme, fallback to browser
        window.location.href = `youtube://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
        setTimeout(() => {
          window.location.href = youtubeSearchURL; // fallback to browser
        }, 500);
      } else {
        // Desktop ‚Üí custom popup window
        const w = window.screen.width / 2; // half screen width
        const h = window.screen.height; // full height
        const left = window.screen.width - w; // right side
        const top = 0;

        window.open(youtubeSearchURL, "_blank", `width=${w},height=${h},top=${top},left=${left}`);
      }

      // Re-enable after 3 seconds
      setTimeout(() => {
        canClick = true;
        titleIcon.style.pointerEvents = "auto";
      }, 3000);
    });
  // Desktop: popup window tab ----end //

    // Play click sound
    function playClickSound() {
      const click = document.getElementById("clickSound");
      if (click) {
        click.currentTime = 0;
        click.play().catch((e) => console.log("Click sound blocked", e));
      }
    }

    // Play success sound
    function playSuccessSound() {
      const success = document.getElementById("successSound");
      if (success) {
        success.currentTime = 0;
        success.play().catch((e) => console.log("Success sound blocked", e));
      }
    }

    // Play error sound
    function playErrorSound() {
      const error = document.getElementById("errorSound");
      if (error) {
        error.currentTime = 0;
        error.play().catch((e) => console.log("Error sound blocked", e));
      }
    }

    // Play trash sound
    function playTrashSound() {
      const trash = document.getElementById("trashSound");
      if (trash) {
        trash.currentTime = 0;
        trash.play().catch((e) => console.log("trash sound blocked", e));
      }
    }

    // Play slide sound
    function playSlideSound() {
      const slide = document.getElementById("slideSound");
      if (slide) {
        slide.currentTime = 0;
        slide.play().catch((e) => console.log("slide sound blocked", e));
      }
    }

    // Play notif sound
    function playNotifSound() {
      const notif = document.getElementById("notifSound");
      if (notif) {
        notif.currentTime = 0;
        notif.play().catch((e) => console.log("notif sound blocked", e));
      }
    }

    document.querySelectorAll(".cyan-btn").forEach((btn) => {
      btn.addEventListener("click", playClickSound);
    });

    // Intercept Android back button using history
    window.addEventListener("load", () => {
      // Push dummy history state to trap the back button
      history.pushState(null, document.title, location.href);
    });

    async function pasteFromClipboard() {
      playClickSound(); // Play click sound immediately

      try {
        const text = await navigator.clipboard.readText();
        const input = document.getElementById("youtubeInputDrawer");
        input.focus(); // optional
        input.value = text;

        const videoId = extractVideoId(text);

        if (!videoId) {
          input.value = "";
        playErrorSound();
        setTimeout(() => {
          showPopup("‚ö†Ô∏è Invalid Youtube URL!", "red", false, "red");
        }, 500);
        } else {
          input.dispatchEvent(new Event("input")); // Trigger glow if needed
          await reserveFromDrawer(); // ‚úÖ Auto-reserve if valid
        }
      } catch (err) {
        playErrorSound();
        setTimeout(() => {
          showPopup("‚ö†Ô∏è Failed! Paste manually", "red", true, true);
        }, 500);
        console.error("Clipboard error:", err);
      }
    }
    document.getElementById("pasteBtn").addEventListener("click", pasteFromClipboard);


// ==========================================
// GENERIC MODAL SYSTEM
// ==========================================
let __modal_onClose = null;
let __modal_keydownHandler = null;
let __modal_prevActive = null;
let isModalOpen = false;

function showModal(settings) {
  isModalOpen = true;
  const overlay = document.getElementById("genericOverlay");
  const modal = document.getElementById("genericModal");
  const content = document.getElementById("genericContent");

  if (!overlay || !modal || !content) {
    console.error("[Modal] Missing genericOverlay/genericModal/genericContent in HTML.");
    return;
  }

  const {
    glowColor = "cyan",
    title = "",
    titleColor = "white",
    titleStyle,
    messages = [],
    buttons = [],
    closeOnOverlay = true,
    onClose = null,
    showCloseButton = false // optional top-right X button
  } = settings || {};

  __modal_onClose = typeof onClose === "function" ? onClose : null;
  __modal_prevActive = document.activeElement;

  content.innerHTML = "";

  // Title
  if (title) {
    let baseStyle = `font-family: 'Orbitron', sans-serif; font-size:1.1em; margin-bottom:10px; color:${titleColor};`;
    if (titleStyle) baseStyle += " " + titleStyle;
    content.innerHTML += `<p class="gm-title" style="${baseStyle}">${_escapeHtml(title)}</p>`;
  }

  // Messages
  for (const msg of messages) {
    const color = msg?.color || "white";
    const text = msg?.text || "";
    const extraStyle = msg?.style || "";
    content.innerHTML += `<p class="gm-msg" style="color:${color}; ${extraStyle}">${_escapeHtml(text)}</p>`;
  }

  content.innerHTML += `<div style="height:0.5px;"></div>`;

// Buttons
if (buttons.length > 0) {
  // Remove Cancel buttons if X button is used
  const filteredButtons = showCloseButton
    ? buttons.filter(btn => btn.label.toLowerCase() !== "cancel")
    : buttons;

  if (filteredButtons.length > 0) {
    const btnContainer = document.createElement("div");
    btnContainer.className = "modal-buttons";
    btnContainer.style.display = "flex";
    btnContainer.style.justifyContent = "center";
    btnContainer.style.gap = "10px"; // spacing between buttons
    btnContainer.style.marginTop = "20px";

    filteredButtons.forEach((btn, i) => {
      const extra = btn?.className ? " " + btn.className : "";
      const label = btn?.label || "OK";
      const buttonEl = document.createElement("button");
      buttonEl.id = `modalBtn${i}`;
      buttonEl.className = `cyan-btn${extra}`;
      buttonEl.style.minWidth = "85px";   // minimum width
      buttonEl.style.maxWidth = "150px";  // maximum width
      buttonEl.innerHTML = _escapeHtml(label);
        // Apply custom styles if provided
        if (btn?.style) {
          buttonEl.style.cssText += btn.style;
        }
      btnContainer.appendChild(buttonEl);
    });

    content.appendChild(btnContainer);
  }
}

// Optional top-right X button
if (showCloseButton) {
  const xBtn = document.createElement("button");
  xBtn.innerHTML = "&times;"; // √ó symbol
  xBtn.style.position = "absolute";
  xBtn.style.top = "10px";
  xBtn.style.right = "10px";
  xBtn.style.background = "transparent";
  xBtn.style.border = "none";
  xBtn.style.color = "gray";
  xBtn.style.fontSize = "1.3em";
  xBtn.style.cursor = "pointer";
  xBtn.style.transition = "all 0.2s ease"; // smooth animation
  xBtn.title = "Close";

  // Hover effect
  xBtn.addEventListener("mouseenter", () => {
    xBtn.style.color = "#ff4c4c";   // highlight on hover
    xBtn.style.transform = "scale(1.2)"; // slight zoom
  });
  xBtn.addEventListener("mouseleave", () => {
    xBtn.style.color = "gray"; 
    xBtn.style.transform = "scale(1)";
  });

  xBtn.onclick = () => setTimeout(() => hideModal(), 200);
  modal.appendChild(xBtn);
}

  _applyModalGlow(modal, glowColor);

  overlay.style.display = "block";
  modal.style.display = "inline-block";

  // Button click handlers
  buttons.forEach((btn, i) => {
    const el = document.getElementById(`modalBtn${i}`);
    if (!el) return;
    el.addEventListener(
      "click",
      () => {
        try {
          if (typeof btn.onClick === "function") btn.onClick();
        } finally {
          setTimeout(() => hideModal(), 200);
        }
      },
      { once: true }
    );
  });

  overlay.onclick = closeOnOverlay ? () => setTimeout(() => hideModal(), 200) : null;

  __modal_keydownHandler = (ev) => {
    if (ev.key === "Escape") hideModal();
  };
  document.addEventListener("keydown", __modal_keydownHandler);

  const firstBtn = content.querySelector("button");
  if (firstBtn) firstBtn.focus();
}

function hideModal() {
  isModalOpen = false;
  const overlay = document.getElementById("genericOverlay");
  const modal = document.getElementById("genericModal");

  if (overlay) overlay.style.display = "none";
  if (modal) modal.style.display = "none";

  // Remove any X button from previous modal
  const oldXBtn = modal.querySelector("button[title='Close']");
  if (oldXBtn) modal.removeChild(oldXBtn);

  if (__modal_keydownHandler) {
    document.removeEventListener("keydown", __modal_keydownHandler);
    __modal_keydownHandler = null;
  }

  if (__modal_prevActive?.focus) {
    try {
      __modal_prevActive.focus();
    } catch (_) {}
  }
  __modal_prevActive = null;

  if (__modal_onClose) {
    const cb = __modal_onClose;
    __modal_onClose = null;
    try {
      cb();
    } catch (err) {
      console.error(err);
    }
  }
}

// Helpers
function _escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function _applyModalGlow(modalEl, glowColor) {
  modalEl.style.border = `1px solid ${glowColor}`;
  modalEl.style.boxShadow = `0 0 10px 0.5px ${glowColor}`;
  modalEl.style.setProperty("--btn-glow", glowColor);

  const rgba020 = _colorToRGBA(glowColor, 0.2);
  modalEl.style.setProperty("--btn-hover-bg", rgba020);
}

function _colorToRGBA(colorStr, alpha) {
  const tmp = document.createElement("span");
  tmp.style.color = colorStr;
  tmp.style.display = "none";
  document.body.appendChild(tmp);

  const rgb = getComputedStyle(tmp).color;
  document.body.removeChild(tmp);

  const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
  if (!m) return `rgba(0, 255, 255, ${alpha || 1})`;
  const r = Number(m[1]),
    g = Number(m[2]),
    b = Number(m[3]);
  const a = typeof alpha === "number" ? alpha : 1;
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}

    //   ==========================================
    //   NEXT MODAL
    //   ==========================================
    function showNextConfirm() {
      const nextSong = queue[currentIndex + 1];
      showModal({
        glowColor: "cyan",
        title: "UP NEXT",
        titleColor: "cyan",
        messages: [
          {
            text: nextSong ? `"${nextSong.title}"` : "No song available.",
            color: "white",
            style: "font-family: Segoe UI, sans-serif;"
          },
          {
            text: "Proceed to the next song?",
            color: "gray",
            style: "font-family: Segoe UI, sans-serif;"
          }
        ],
        buttons: [{ label: "Confirm", onClick: confirmPlayNext }, { label: "Cancel" }],
        showCloseButton: false // ‚ùå No X button
      });
    }

    function confirmPlayNext() {
      playNextFromQueue(); // just run the action
      closeBottomDrawer();
    }

    //   ==========================================
    //  EXIT MODAL
    //  ===========================================
    function showExitConfirm() {
      showModal({
        glowColor: "magenta",
        title: "EXIT ?",
        titleColor: "magenta",
        messages: [
          {
            text: "Press back twice to leave the app.",
            color: "white",
            style: "font-family: 'Segoe UI', sans-serif;"
          },
          {
            text: "‚ö†Ô∏è Irreversible action: your queue will be cleared and cannot be restored.",
            color: "gray",
            style: "font-family: 'Segoe UI', sans-serif;"
          }
        ],
        buttons: [{ label: "Cancel" }],
        showCloseButton: false // ‚ùå No X button
      });
      playErrorSound();
    }

    //  =========================================================
    //  DELETE MODAL
    //  ========================================================= */
    function showDeleteConfirm(index, onCloseCallback) {
      const songTitle = queue[index]?.title || "Unknown Song";

      showModal({
        glowColor: "red",
        title: "REMOVE ?",
        titleColor: "red",
        messages: [
          {
            text: `"${songTitle}"`,
            color: "white",
            style: "font-family: 'Segoe UI', sans-serif"
          },
          {
            text: " ",
            color: "#ff4c4c",
            style: "font-family: 'Segoe UI', sans-serif"
          }
        ],
        buttons: [
          {
            label: "Confirm",
            onClick: () => {
              const list = document.getElementById("nextList");
              // Index shift: queue starts from currentIndex+1
              const item = list.children[index - (currentIndex + 1)];

              if (item) {
                item.classList.add("removing");

                // Wait for transition, then remove
                item.addEventListener(
                  "transitionend",
                  () => {
                    playTrashSound();
                    queue.splice(index, 1);
                    updateQueueDisplay();
                  },
                  { once: true }
                );
              } else {
                // fallback if something goes wrong
                playTrashSound();
                queue.splice(index, 1);
                updateQueueDisplay();
              }
            }
          },
         { 
          label: "Cancel", 
          onClick: () => {
            playClickSound();
          } 
        }
        ],
        onClose: () => {
          if (typeof onCloseCallback === "function") onCloseCallback();
        },
        showCloseButton: false // Classic modal: Cancel button stays, no X  
      });
    }

//  =========================================================
//  Idle Fucntion for Left and Bottom drawer handles
//  =========================================================
let idleTimer;
const idleDelay = 3000; // 3 seconds
const idleTargets = document.querySelectorAll(".drawer-handle, .bottom-drawer-handle");

function setIdle() {
  idleTargets.forEach((el) => el.classList.add("idle"));
}

function resetIdle() {
  idleTargets.forEach((el) => el.classList.remove("idle"));
  clearTimeout(idleTimer);
  idleTimer = setTimeout(setIdle, idleDelay);
}

// Events that reset idle
["mousemove", "keydown", "click", "scroll", "touchstart", "touchmove"].forEach((event) => {
  window.addEventListener(event, resetIdle, { passive: true });
});

// Start on load
resetIdle();

//  ==============================
//  Songbook Toggle (with search show/hide)
//  ==============================
function toggleSongbook() {
  playClickSound();

  const sb = document.getElementById("songbook");                   // Songbook container
  const handle = document.querySelector(".songbook-handle");        // Handle button
  const searchWrapper = document.getElementById("songbookSearchWrapper"); // Search bar wrapper

// ------------------------------
// Toggle songbook open/close
// ------------------------------
sb.classList.toggle("open");

// ------------------------------
// Show/hide search bar based on open state
// ------------------------------
if (sb.classList.contains("open")) {
  searchWrapper.style.display = "block";  // show search when open
} else {
  searchWrapper.style.display = "none";   // hide search when closed
}

// ------------------------------
// Trigger handle click animation
// ------------------------------
handle.classList.add("clicked");

// Normal reset after 200ms
setTimeout(() => {
  handle.classList.remove("clicked");
}, 200);

// Safety reset after 1s (in case it didn't reset)
setTimeout(() => {
  if (handle.classList.contains("clicked")) {
    handle.classList.remove("clicked");
  }
}, 1000);
}

 
// ==============================
// Songbook Search-Bar
// ==============================
function filterSongbook() {
  const input = document.getElementById("songbookSearch").value.toLowerCase();
  const songs = document.querySelectorAll("#songbookList .songtitle");
  const noResults = document.getElementById("noResults");

  let hasMatch = false;

  songs.forEach(song => {
    const text = song.textContent.toLowerCase();
    if (text.includes(input)) {
      song.style.display = "";
      hasMatch = true;
    } else {
      song.style.display = "none";
    }
  });

  // Hide "No results found" if search is empty
  if (input === "") {
    noResults.style.display = "none";
  } else {
    noResults.style.display = hasMatch ? "none" : "block";
  }
}

// ==============================
// Save to Songbook (Unified validation + fetchTitle)
// ==============================
async function saveToSongbook() {
  playClickSound(); // Play click sound immediately

  const input = document.getElementById("youtubeInputDrawer");
  const url = input.value.trim();

  if (!url) {
    playErrorSound();
    setTimeout(() => {
      showPopup("‚ö†Ô∏è Please paste a URL first", "red", true, true);
    }, 500);
    return;
  }

  const videoId = extractVideoId(url);
  if (!videoId) {
    input.value = "";
    playErrorSound();
    setTimeout(() => {
      showPopup("‚ö†Ô∏è Invalid Youtube URL!", "red", true, true);
    }, 500);
    return;
  }

  const title = await fetchTitle(videoId);
  if (title.startsWith("Invalid Song")) {
    input.value = "";
    return;
  }

  // ‚úÖ Only save after validation & title fetched
  await db.collection("users").doc(currentUser.id).update({
    songbook: firebase.firestore.FieldValue.arrayUnion({
      url: `https://www.youtube.com/watch?v=${videoId}`,
      title: title
    })
  });

  // Create new song element
  const songList = document.getElementById("songbookList");
  const songDiv = document.createElement("div");
  songDiv.className = "songtitle";
  songDiv.textContent = title;

  // Save both URL and videoId in dataset
  songDiv.dataset.url = `https://www.youtube.com/watch?v=${videoId}`;
  songDiv.dataset.id = videoId;

  attachSongbookInteractions(songDiv);
  songList.appendChild(songDiv);

  input.value = "";

  setTimeout(() => {
    showPopup("Saved!", "cyan", false, "cyan"); playSuccessSound();
  }, 500);
    setTimeout(() => {
      showAlert("‚úÖ New Song added to Songbook", "success");
  }, 1800);
}
  

//  ============================== 
//  Smooth Overscroll Effect for SongBook (with auto bottom padding)
//  ==============================
(function smoothStretchScrollSongbook() {
  const wrapper = document.querySelector(".songbook-box");
  const box = document.querySelector(".songbook-box-inner");
  if (!wrapper || !box) return;

  let startY = 0;
  let isTouching = false;
  let pulling = false;
  let stretch = 0;
  let rafId = null;
  const maxStretch = 60;

  // üîπ Auto add bottom padding so last item is always visible
  box.style.paddingBottom = `${maxStretch}px`;

  const updateTransform = () => {
    wrapper.style.transform = `translateY(${stretch}px)`;
    rafId = null;
  };

  wrapper.addEventListener("touchstart", (e) => {
    startY = e.touches[0].clientY;
    isTouching = true;
    pulling = false;
    stretch = 0;
    wrapper.style.transition = "";
  }, { passive: true });

  wrapper.addEventListener("touchmove", (e) => {
    if (!isTouching) return;

    const currentY = e.touches[0].clientY;
    const deltaY = currentY - startY;
    const maxScroll = box.scrollHeight - box.clientHeight;

    if ((box.scrollTop <= 0 && deltaY > 0) || (box.scrollTop >= maxScroll && deltaY < 0)) {
      pulling = true;
      const resistance = 1 - Math.min(Math.abs(deltaY) / (maxStretch * 4), 0.75);
      stretch = Math.max(-maxStretch, Math.min(deltaY * resistance, maxStretch));

      if (!rafId) rafId = requestAnimationFrame(updateTransform);
      e.preventDefault();
    }
  }, { passive: false });

  wrapper.addEventListener("touchend", () => {
    if (pulling) {
      wrapper.style.transition = "transform 0.35s cubic-bezier(.25,.46,.45,.94)";
      wrapper.style.transform = "translateY(0)";
    }
    isTouching = false;
    pulling = false;
    stretch = 0;
  });
})();


//  ==============================
//  SongBook Right-Click Actions + Ripple + Long-Press
//  ==============================
const songbookList = document.getElementById("songbookList");

// Initial binding for existing songs
document.querySelectorAll("#songbookList .songtitle").forEach(attachSongbookInteractions);



// ===============================
// Attach interactions (single tap)
// ===============================
function attachSongbookInteractions(div) {
  // ---------- Ripple Effect ----------
  div.addEventListener("click", () => {
    // ripple feel
    div.classList.add("ripple");
    setTimeout(() => div.classList.remove("ripple"), 500);

    // delay modal popup (200ms)
    setTimeout(() => {
      openSongOptions(div);
    }, 200);
  });

  // ---------- Hover Flash (desktop only) ----------
  div.addEventListener("mouseenter", () => {
    div.classList.add("hover-flash");
    setTimeout(() => div.classList.remove("hover-flash"), 500);
  });

  // ---------- Context Menu (right-click) ----------
  div.addEventListener("contextmenu", (e) => {
    e.preventDefault();

    // delay modal popup a bit longer (350ms)
    setTimeout(() => {
      openSongOptions(div);
    }, 350);
  });
}

//  ==============================
//  Song Options Modal
//  ==============================
function openSongOptions(target, onClose) {
  const songTitle = target.textContent;
  const songUrl = target.dataset.url;   // kept for reference
  const songId = target.dataset.id;     // ‚úÖ available for transfer

  showModal({
    glowColor: "cyan",
    title: "SONG OPTIONS",
    titleColor: "cyan",
    messages: [
      { text: `"${songTitle}"`, color: "white", style: "font-family: 'Segoe UI', sans-serif" }
    ],
    buttons: [
      {
        label: "Delete",
        style: "font-size: 0.9em", // smaller font
        onClick: () => {
          playClickSound();
          __modal_onClose = () => {
            showModal({
              glowColor: "red",
              title: "DELETE ?",
              titleColor: "red",
              messages: [
                { text: `"${songTitle}"`, color: "white", style: "font-family: 'Segoe UI', sans-serif"},
                {
                  text: "‚ö†Ô∏è Irreversible action: Permanently deleted from the songbook.",
                  color: "gray",
                  style: "font-family: 'Segoe UI', sans-serif;"
                }
              ],
              buttons: [
                {
                  label: "Confirm",
                  onClick: async () => {
                    try {
                      target.classList.add("removing");

                      const songUrl = target.dataset.url;
                      const songTitle = target.textContent;

                      // üîπ Remove from user‚Äôs songbook array
                      const userRef = db.collection("users").doc(currentUser.id);
                      const userDoc = await userRef.get();
                      if (userDoc.exists) {
                        const currentBook = userDoc.data().songbook || [];
                        const updatedBook = currentBook.filter(s => s.url !== songUrl);
                        await userRef.update({ songbook: updatedBook });
                      }

                      // üîπ Optional: remove from "songs" collection if needed
                      if (target.dataset.id) {
                        await db.collection("songs").doc(target.dataset.id).delete().catch(() => {});
                      }

                      // üîπ Remove from UI
                      setTimeout(() => {
                        playTrashSound();
                        target.remove();
                        showPopup("Deleted!", "red", false, true);
                        onClose?.();
                      }, 500);

                    } catch (err) {
                      playErrorSound();
                      console.error("Delete failed:", err);
                      showPopup("‚ö†Ô∏è Failed to delete", "red", true, true);
                    }
                  }
                },
                {
                  label: "Cancel",
                  onClick: () => {
                    playClickSound();
                  }
                }
              ]
            });
          };
        }
      },
      {
        label: "Reserve",
        style: "font-size: 0.9em", // smaller font
        onClick: () => {
          playClickSound();
          // üîß Same as reserveFromDrawer but using songId
          if (queue.length === 0 && currentIndex === -1) {
            queue.push({ id: songId, title: songTitle });
            currentIndex = 0;

            player.loadVideoById(songId);
            player.playVideo();
            updateNowPlaying();
          } else {
            queue.push({ id: songId, title: songTitle });
          }

          updateQueueDisplay();
          
          setTimeout(() => {
            showPopup("Reserved!", "cyan", false, true); playSuccessSound();
          }, 500);

          onClose?.();
        }
      },
{
  label: "Send",
  style: "font-size: 0.9em", // smaller font
  onClick: () => {
    playClickSound();

    __modal_onClose = () => {
      showModal({
        glowColor: "cyan",
        title: "SEND",
        titleColor: "cyan",
        messages: [
          { text: `"${songTitle}"`, color: "white", style: "font-family: 'Segoe UI', sans-serif; font-size: 1.0em" }
        ],
        buttons: [
          {
            label: "Send",
            onClick: async () => {
              try {
                // üîπ Grab the input value
                const recipientInput = document.getElementById("recipientIdInput");
                const recipientId = recipientInput ? recipientInput.value.trim() : "";
                if (!recipientId) {
                  playErrorSound();
                  showAlert("‚ö†Ô∏è Enter a User ID!", "error");
                  return;
                }

                // Check if recipient exists
                const userDoc = await db.collection("users").doc(recipientId).get();
                if (!userDoc.exists) {
                  playErrorSound();
                  showAlert("‚ö†Ô∏è Invalid User ID!", "error");
                  return;
                }

                // Send the song
                await db.collection("transfers").add({
                  to: recipientId,
                  from: currentUser.id,
                  song: { id: songId, title: songTitle }
                });

                playSuccessSound();
                showPopup("Sent!", "cyan", false, true);
                onClose?.();

              } catch (err) {
                playErrorSound();
                console.error("Send failed:", err);
                showPopup("‚ö†Ô∏è Failed to send", "red", true, true);
              }
            }
          },
          {
            label: "Cancel",
            onClick: () => playClickSound()
          }
        ],
        showCloseButton: true
      });

// ‚úÖ Add the input dynamically (styled like .url-input)
setTimeout(() => {
  const content = document.getElementById("genericContent");
  if (content) {
    const input = document.createElement("input");
    input.id = "recipientIdInput";
    input.type = "text";
    input.placeholder = "Enter receiver's User ID";
    input.style.cssText = `
      flex: 1;
      width: 100%;
      min-width: 210px;
      max-width: 50vw;
      height: 40px;
      border-radius: 20px;
      border: none;
      background-color: black;
      text-align: center;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: transform 1s, box-shadow 0.3s;
      outline: none;
      margin-top: 12px;
    `;

    // ‚úÖ Add glow + white outline on hover/focus
    input.addEventListener("mouseenter", () => {
      input.style.boxShadow = "0 0 10px .5px cyan, 0 0 0 1px white";
    });
    input.addEventListener("mouseleave", () => {
      input.style.boxShadow = "none";
    });
    input.addEventListener("focus", () => {
      input.style.boxShadow = "0 0 12px 1px cyan, 0 0 0 1px white";
    });
    input.addEventListener("blur", () => {
      input.style.boxShadow = "none";
    });
    // ‚úÖ Insert before the buttons and focus
    content.insertBefore(input, content.lastElementChild);
    input.focus();
  }
      }, 150);
    };
  }
}
      // ‚ùå Cancel button removed here as well
    ],
    showCloseButton: true // ‚úÖ Enable top-right X button
  });
}
</script>

  </body>
</html>
